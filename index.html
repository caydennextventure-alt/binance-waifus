<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: blob: https://mintlify.s3.us-west-1.amazonaws.com https://assets.coingecko.com https://cdn.jsdelivr.net https://raw.githubusercontent.com https://images.ctfassets.net https://avatars.githubusercontent.com https://backpack.app https://www.madlads.com https://pbs.twimg.com https://static.okx.com https://img.bitgetimg.com https://tp-statics.tokenpocket.pro https://trustwallet.com; media-src 'self' blob: data:; connect-src 'self' blob: http://localhost:3000 https://rpc.xlayer.tech https://api.elevenlabs.io https://vrm-eliza-ai-girlfriend.vercel.app https://*.railway.app https://vrm-elizaos-ai-girlfriend-production.up.railway.app; ">
    <title>Â∏ÅÂÆâÂ•≥Âèã - AI Girlfriend</title>
    <link rel="icon" type="image/png" href="profile-pic/sikirei-pf.png">

    <link rel="stylesheet" href="responsive-standard.css">
    <link rel="stylesheet" href="index-responsive.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            color: white;
            position: relative;
            margin: 0;
            padding: 0;
            background: url('public/BG/createnow-image-1768147272992.png') center/cover no-repeat;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Top title */
        .heroes-title {
            position: absolute;
            top: 12px;
            left: 12px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        /* Language switcher */
        .language-toggle {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #ff9a56 0%, #ffad56 50%, #ffc056 100%);
            border-radius: 10px;
            border: 4px solid rgba(74, 44, 90, 0.8);
            padding: 6px 12px;
            z-index: 101;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #2d1b3d;
            font-weight: bold;
            font-size: 11px;
        }

        .language-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(74, 44, 90, 0.8);
            border-radius: 5px;
            padding: 3px 6px;
            cursor: pointer;
            font-size: 9px;
            font-weight: bold;
            color: #2d1b3d;
            transition: all 0.2s ease;
        }

        .language-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }

        .language-btn.active {
            background: rgba(74, 44, 90, 0.8);
            color: white;
        }

        /* Character info panel - Japanese style profile card design */
        .character-info {
            position: absolute;
            top: 50px;
            left: 12px;
            width: 170px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(200, 200, 200, 0.5);
            border-radius: 7px;
            padding: 0;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            transform: scale(1.3);
            transform-origin: top left;
        }

        .character-name {
            font-size: 10px;
            font-weight: bold;
            color: #333;
            margin: 0;
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(200, 200, 200, 0.3);
        }

        .profile-section {
            margin-bottom: 2px;
        }

        .profile-header {
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
            color: white;
            padding: 4px 8px;
            font-size: 7px;
            font-weight: 600;
            position: relative;
            border-left: 2px solid #e91e63;
        }

        .profile-content {
            background: rgba(248, 248, 248, 0.95);
            padding: 8px;
            color: #333;
        }

        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(200, 200, 200, 0.3);
        }

        .profile-row:last-child {
            border-bottom: none;
        }

        .profile-label {
            font-size: 7px;
            color: #666;
            font-weight: 500;
        }

        .profile-value {
            font-size: 7px;
            color: #333;
            font-weight: 600;
        }

        .profile-text {
            font-size: 7px;
            color: #333;
            line-height: 1.4;
            padding: 2px 0;
        }

        .favorite-section {
            background: rgba(248, 248, 248, 0.95);
            padding: 8px;
            color: #333;
            text-align: center;
            font-size: 7px;
        }

        .expand-button {
            position: absolute;
            top: 4px;
            right: 6px;
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 2px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
        }

        /* refresh-button decoration removed */

        /* Floating voice selector styles - based on reference screenshot */
        .voice-selector-floating {
            position: absolute;
            top: 12%;
            /* Move up a bit more to avoid covering faces */
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 12px 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: fadeInUp 0.6s ease-out;
        }

        .language-flags {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .flag-btn {
            background: transparent;
            border: none;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            opacity: 0.7;
            position: relative;
        }

        .flag-btn:hover {
            transform: scale(1.15);
            opacity: 1;
        }

        .flag-btn.active {
            opacity: 1;
            background: rgba(100, 150, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(100, 150, 255, 0.4);
            transform: scale(1.1);
        }

        .flag-btn.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: #4285f4;
            border-radius: 50%;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate(-50%, -40%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* Mobile optimizations moved to index-responsive.css */

        /* Central character name display */
        .character-display-name {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 36px;
            font-weight: bold;
            color: white;
            text-shadow: 1.5px 1.5px 3px rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0.9;
        }

        /* VRM display area - central */
        .vrm-display {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vrm-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Simplified loading animation styles */
        .character-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            animation: fadeInLoader 0.3s ease-out;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border-radius: 16px;
            box-shadow: 40px 0px 0 0 rgba(255, 255, 255, 0.2),
                32.4px 23.5px 0 0 rgba(255, 255, 255, 0.4),
                12.4px 38px 0 0 rgba(255, 255, 255, 0.6),
                -12.4px 38px 0 0 rgba(255, 255, 255, 0.8),
                -32.4px 23.5px 0 0 #ffffff;
            animation: spinner-rotate 1s infinite linear;
            margin-bottom: 20px;
        }

        .loader-text {
            font-size: 16px;
            color: white;
            text-align: center;
            letter-spacing: 3px;
            font-weight: 600;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        @keyframes spinner-rotate {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeInLoader {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }



        /* Character selector - bottom - mimicking screenshot style */
        .character-selector {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 12px 31px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            border-radius: 60px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 100;
            box-shadow: 0 1px 7px rgba(0, 0, 0, 0.1);
        }

        /* Navigation buttons - left/right arrows */
        .nav-button {
            width: 42px;
            height: 42px;
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 21px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .character-thumbnails {
            display: flex;
            gap: 9px;
            align-items: center;
        }

        .character-thumb {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            background: white;
        }

        /* Currently selected character */
        .character-thumb.active {
            border-color: #FFD700;
            transform: scale(1.15);
            box-shadow: 0 0 7px rgba(255, 215, 0, 0.6);
        }

        /* Center selection indicator - mimicking screenshot design */
        .selected-indicator {
            width: 75px;
            height: 105px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 18px;
            border: 1.5px solid rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 6px;
            margin: 0 9px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .selected-indicator .selected-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 6px;
            border: 1.5px solid white;
        }

        .selected-indicator .selected-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .selected-indicator .selected-badge {
            width: 18px;
            height: 18px;
            background: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .selected-indicator .selected-text {
            color: #666;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .character-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-thumb:hover {
            transform: scale(1.05);
            border-color: white;
        }

        .character-thumb.selected {
            width: 40px;
            height: 40px;
            border-color: #333;
            border-width: 2px;
            transform: scale(1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .character-thumb.selected::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border: 2px solid #ffd700;
            border-radius: 50%;
            z-index: -1;
        }

        .character-thumb.selected::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: #ffd700;
            border-radius: 50%;
        }

        .select-indicator {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: white;
            font-weight: 500;
        }






        .wallet-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 20px;
        }

        .wallet-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .wallet-address {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .wallet-balance {
            color: #888888;
            font-size: 12px;
        }

        .wallet-actions {
            position: relative;
        }

        .wallet-menu-btn {
            background: none;
            border: none;
            color: #888888;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .wallet-menu-btn:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        .wallet-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 12px;
            min-width: 180px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            z-index: 1001;
            overflow: hidden;
            display: none;
        }

        .wallet-dropdown-item {
            padding: 12px 16px;
            color: #ffffff;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-dropdown-item:hover {
            background: #2a2a2a;
        }

        .wallet-dropdown-item:last-child {
            border-top: 1px solid #333333;
            color: #ef4444;
        }

        .wallet-dropdown-item:last-child:hover {
            background: rgba(239, 68, 68, 0.1);
        }



        /* Footer */
        .wallet-modal-footer {
            text-align: center;
            padding-top: 24px;
            border-top: 1px solid #2a2a2a;
        }

        .wallet-modal-footer p {
            color: #666666;
            font-size: 14px;
            line-height: 1.5;
        }

        .wallet-link {
            color: #4f46e5;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .wallet-link:hover {
            color: #6366f1;
        }

        /* Animations */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Message notification */
        .wallet-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 12px;
            padding: 12px 20px;
            color: #ffffff;
            font-size: 14px;
            z-index: 10001;
            animation: toastSlideIn 0.3s ease;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .wallet-toast-success {
            border-left: 4px solid #10b981;
        }

        .wallet-toast-error {
            border-left: 4px solid #ef4444;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }


        /* Start button - modern gradient design */
        .start-button {
            --h-button: 100px;
            --w-button: 280px;
            --round: 50px;
            cursor: pointer;
            position: absolute;
            bottom: 40px;
            right: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            transition: all 0.25s ease;
            animation: pulse 2s infinite;
            box-shadow: 0 8px 30px rgba(135, 206, 250, 0.4);
            background: linear-gradient(135deg, #E6B3FF 0%, #B3D9FF 100%);
            border-radius: var(--round);
            border: 2px solid rgba(255, 255, 255, 0.6);
            outline: none;
            padding: 15px 30px;
            z-index: 100;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .start-button::before {
            content: "‚ú®";
            position: absolute;
            left: -20px;
            top: -10px;
            font-size: 16px;
            animation: twinkle 1.5s infinite alternate;
        }

        .start-button::after {
            content: "‚ú®";
            position: absolute;
            right: -15px;
            bottom: -5px;
            font-size: 14px;
            animation: twinkle 1.8s infinite alternate;
        }

        @keyframes twinkle {
            0% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            100% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        .start-button:active {
            transform: scale(0.95);
        }

        .start-button:hover {
            box-shadow: 0 12px 40px rgba(135, 206, 250, 0.6);
            transform: translateY(-2px);
        }

        .points_wrapper {
            overflow: hidden;
            width: 100%;
            height: 100%;
            pointer-events: none;
            position: absolute;
            z-index: 1;
        }

        .points_wrapper .point {
            bottom: -10px;
            position: absolute;
            animation: floating-points infinite ease-in-out;
            pointer-events: none;
            width: 2px;
            height: 2px;
            background-color: #fff;
            border-radius: 9999px;
        }

        @keyframes floating-points {
            0% {
                transform: translateY(0);
            }

            85% {
                opacity: 0;
            }

            100% {
                transform: translateY(-55px);
                opacity: 0;
            }
        }

        .points_wrapper .point:nth-child(1) {
            left: 10%;
            opacity: 1;
            animation-duration: 2.35s;
            animation-delay: 0.2s;
        }

        .points_wrapper .point:nth-child(2) {
            left: 30%;
            opacity: 0.7;
            animation-duration: 2.5s;
            animation-delay: 0.5s;
        }

        .points_wrapper .point:nth-child(3) {
            left: 25%;
            opacity: 0.8;
            animation-duration: 2.2s;
            animation-delay: 0.1s;
        }

        .points_wrapper .point:nth-child(4) {
            left: 44%;
            opacity: 0.6;
            animation-duration: 2.05s;
        }

        .points_wrapper .point:nth-child(5) {
            left: 50%;
            opacity: 1;
            animation-duration: 1.9s;
        }

        .points_wrapper .point:nth-child(6) {
            left: 75%;
            opacity: 0.5;
            animation-duration: 1.5s;
            animation-delay: 1.5s;
        }

        .points_wrapper .point:nth-child(7) {
            left: 88%;
            opacity: 0.9;
            animation-duration: 2.2s;
            animation-delay: 0.2s;
        }

        .points_wrapper .point:nth-child(8) {
            left: 58%;
            opacity: 0.8;
            animation-duration: 2.25s;
            animation-delay: 0.2s;
        }

        .points_wrapper .point:nth-child(9) {
            left: 98%;
            opacity: 0.6;
            animation-duration: 2.6s;
            animation-delay: 0.1s;
        }

        .points_wrapper .point:nth-child(10) {
            left: 65%;
            opacity: 1;
            animation-duration: 2.5s;
            animation-delay: 0.2s;
        }

        .inner {
            z-index: 2;
            gap: 3px;
            position: relative;
            width: 100%;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            line-height: 1.5;
            transition: color 0.2s ease-in-out;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8),
                0 0 40px rgba(223, 113, 255, 0.6);
            letter-spacing: 0.1em;
        }

        .inner svg.icon {
            width: 9px;
            height: 9px;
            transition: fill 0.1s linear;
        }

        .start-button:focus svg.icon {
            fill: white;
        }

        .start-button:hover svg.icon {
            fill: transparent;
            animation:
                dasharray 1s linear forwards,
                filled 0.1s linear forwards 0.95s;
        }

        @keyframes dasharray {
            from {
                stroke-dasharray: 0 0 0 0;
            }

            to {
                stroke-dasharray: 68 68 0 0;
            }
        }

        @keyframes filled {
            to {
                fill: white;
            }
        }


        /* Responsive design moved to index-responsive.css */

        /* User profile panel styles - precise replica design */
        .user-profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.16);
            backdrop-filter: blur(6px);
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        .profile-panel {
            background: white;
            border-radius: 25px;
            padding: 8px;
            /* Add white border effect */
            max-width: 541px;
            /* 416px * 1.3 = 541px - increased by 30% */
            width: 85%;
            max-height: 85vh;
            /* Add maximum height */
            position: relative;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
            border: 3px solid #F0F0F0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .profile-panel-header {
            background: linear-gradient(180deg, #B3E5FC 0%, #81D4FA 50%, #4FC3F7 100%);
            text-align: center;
            padding: 25px 0;
            /* Larger padding */
            margin: 0;
            position: relative;
            flex-shrink: 0;
            /* Prevent header from being compressed */
            border-radius: 20px 20px 0 0;
            /* Only top rounded corners */
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .profile-panel-title {
            font-size: 24px;
            /* Larger font size */
            margin: 0;
            font-weight: 600;
            /* Bolder font weight */
            color: #2E3A47;
            /* Darker color */
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            letter-spacing: 1px;
            /* Increase letter spacing */
        }

        .profile-form {
            padding: 30px;
            /* Adjust padding */
            display: flex;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
            /* Enable vertical scrolling */
            flex: 1;
            /* Take up remaining space */
            max-height: calc(85vh - 90px);
            /* Subtract header and border height */
            background: white;
            border-radius: 0 0 17px 17px;
            /* Bottom rounded corners, matching outer border */
        }

        .profile-field {
            display: flex;
            flex-direction: column;
            gap: 16px;
            /* 12px * 1.3 ‚âà 16px */
            position: relative;
        }

        /* Gold decorative lines */
        .field-label {
            font-size: 18px;
            /* 14px * 1.3 ‚âà 18px */
            font-weight: 500;
            color: #D4AF37;
            text-align: center;
            margin: 0;
            position: relative;
            padding: 0 26px;
            /* 20px * 1.3 ‚âà 26px */
        }

        .field-label::before,
        .field-label::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 52px;
            /* 40px * 1.3 ‚âà 52px */
            height: 1px;
            background: #D4AF37;
        }

        .field-label::before {
            left: 0;
        }

        .field-label::after {
            right: 0;
        }

        .profile-input,
        .profile-select {
            padding: 16px 46px 16px 20px;
            /* 12px*1.3‚âà16px, 35px*1.3‚âà46px, 15px*1.3‚âà20px */
            border: none;
            border-radius: 10px;
            /* 8px * 1.3 ‚âà 10px */
            background: #E1F5FE;
            color: #333;
            font-size: 18px;
            /* 14px * 1.3 ‚âà 18px */
            transition: all 0.3s ease;
            position: relative;
        }

        .profile-input:focus,
        .profile-select:focus {
            outline: none;
            background: #B3E5FC;
        }

        .profile-input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        /* Input box quill icon */
        .profile-field::after {
            content: 'ü™∂';
            position: absolute;
            right: 16px;
            /* 12px * 1.3 ‚âà 16px */
            top: 49px;
            /* 38px * 1.3 ‚âà 49px */
            font-size: 16px;
            /* 12px * 1.3 ‚âà 16px */
            pointer-events: none;
        }

        .name-inputs,
        .birthday-inputs {
            display: flex;
            gap: 10px;
            /* Reduced gap for 3 selects */
            position: relative;
        }

        .name-inputs .profile-input,
        .birthday-inputs .profile-select {
            flex: 1;
        }

        .birthday-inputs .profile-select {
            min-width: 0;
            /* Allow shrinking */
        }

        .field-note {
            font-size: 14px;
            /* 11px * 1.3 ‚âà 14px */
            color: #E91E63;
            line-height: 1.3;
            text-align: center;
            margin-top: 7px;
            /* 5px * 1.3 ‚âà 7px */
        }

        .profile-submit-btn {
            padding: 16px 52px;
            /* 12px*1.3‚âà16px, 40px*1.3‚âà52px */
            border: none;
            border-radius: 26px;
            /* 20px * 1.3 ‚âà 26px */
            font-size: 21px;
            /* 16px * 1.3 ‚âà 21px */
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #FF69B4, #E91E63);
            color: white;
            font-weight: 500;
            margin: 20px auto 0;
            /* 15px * 1.3 ‚âà 20px */
            box-shadow: 0 4px 16px rgba(233, 30, 99, 0.3);
            /* 3px*1.3‚âà4px, 12px*1.3‚âà16px */
            display: block;
            width: 156px;
            /* 120px * 1.3 ‚âà 156px */
        }

        .profile-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
        }

        .profile-submit-btn:active {
            transform: translateY(0px);
        }

        /* Special style adjustments */
        .birthday-inputs .profile-field::after {
            display: none;
            /* Birthday selector doesn't show edit icon */
        }

        .profile-field.has-multiple-inputs::after {
            display: none;
            /* Fields with multiple inputs don't show edit icon */
        }

        /* Memory system styles */
        .memory-section {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            /* 12px * 1.3 ‚âà 16px */
            padding: 26px;
            /* 20px * 1.3 ‚âà 26px */
            margin-top: 13px;
            /* 10px * 1.3 ‚âà 13px */
        }

        .memory-title {
            text-align: center;
            color: #D4AF37;
            font-size: 18px;
            /* 14px * 1.3 ‚âà 18px */
            font-weight: 500;
            margin-bottom: 20px;
            /* 15px * 1.3 ‚âà 20px */
            position: relative;
            padding: 0 26px;
            /* 20px * 1.3 ‚âà 26px */
        }

        .memory-title::before,
        .memory-title::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 39px;
            /* 30px * 1.3 ‚âà 39px */
            height: 1px;
            background: #D4AF37;
        }

        .memory-title::before {
            left: 0;
        }

        .memory-title::after {
            right: 0;
        }

        .memory-field {
            margin-bottom: 16px;
            /* 12px * 1.3 ‚âà 16px */
            position: relative;
        }

        .memory-label {
            font-size: 16px;
            /* 12px * 1.3 ‚âà 16px */
            color: #666;
            margin-bottom: 7px;
            /* 5px * 1.3 ‚âà 7px */
            display: block;
        }

        .memory-input {
            width: 100%;
            padding: 10px 39px 10px 16px;
            /* 8px*1.3‚âà10px, 30px*1.3‚âà39px, 12px*1.3‚âà16px */
            border: none;
            border-radius: 8px;
            /* 6px * 1.3 ‚âà 8px */
            background: #F0F8FF;
            color: #333;
            font-size: 16px;
            /* 12px * 1.3 ‚âà 16px */
            box-sizing: border-box;
        }

        .memory-field::after {
            content: 'ü™∂';
            /* Changed to quill icon */
            position: absolute;
            right: 10px;
            /* 8px * 1.3 ‚âà 10px */
            top: 36px;
            /* 28px * 1.3 ‚âà 36px */
            font-size: 13px;
            /* 10px * 1.3 ‚âà 13px */
            pointer-events: none;
        }

        /* Animation effects */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 10px 40px rgba(223, 113, 255, 0.4);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 15px 60px rgba(223, 113, 255, 0.6);
                transform: scale(1.02);
            }
        }

        .character-info,
        .character-selector,
        .start-button,
        .control-panel {
            animation: fadeInUp 0.8s ease-out;
        }

        /* Mobile Optimization Notice Modal - Game Style */
        .mobile-notice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .mobile-notice-modal {
            background: #f4d03f;
            border: 6px solid #2d1b3d;
            border-radius: 20px;
            padding: 0;
            max-width: 320px;
            width: 90%;
            position: relative;
            animation: modalBounceIn 0.5s ease-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .mobile-notice-header {
            background: linear-gradient(135deg, #2d1b3d 0%, #4a2c5a 100%);
            color: #f4d03f;
            padding: 15px 20px;
            border-radius: 14px 14px 0 0;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 3px solid #f4d03f;
            border-bottom: none;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3);
        }

        .mobile-notice-content {
            padding: 20px;
            color: #2d1b3d;
            font-size: 14px;
            line-height: 1.6;
            text-align: center;
            font-weight: 600;
        }

        .mobile-notice-close {
            background: linear-gradient(135deg, #2d1b3d 0%, #4a2c5a 100%);
            color: #f4d03f;
            border: 3px solid #2d1b3d;
            border-radius: 15px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px auto 0;
            display: block;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.3);
            box-shadow: 0 4px 0px #1a0f1f, 0 6px 10px rgba(0, 0, 0, 0.3);
        }

        .mobile-notice-close:hover {
            background: linear-gradient(135deg, #4a2c5a 0%, #6c4a7a 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 0px #1a0f1f, 0 8px 15px rgba(0, 0, 0, 0.4);
        }

        .mobile-notice-close:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0px #1a0f1f, 0 3px 5px rgba(0, 0, 0, 0.3);
        }

        @keyframes modalBounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(-50px);
            }

            50% {
                opacity: 1;
                transform: scale(1.1) translateY(0);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Show mobile notice only on mobile devices */
        @media (max-width: 768px) {
            .mobile-notice-overlay.show {
                display: flex;
            }
        }
    </style>
</head>

<body>
    <!-- Background Music -->
    <audio id="background-music" loop preload="auto">
        <source src="BG/main-bgm.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Mobile Optimization Notice Modal -->
    <div class="mobile-notice-overlay" id="mobile-notice-overlay">
        <div class="mobile-notice-modal">
            <div class="mobile-notice-header">
                MOBILE NOTICE
            </div>
            <div class="mobile-notice-content">
                The mobile experience is currently being optimized and requires a DApp browser for full functionality.
                <br><br>
                <strong>We recommend using desktop for the best experience.</strong>
            </div>
            <button class="mobile-notice-close" onclick="closeMobileNotice()">CLOSE</button>
        </div>
    </div>

    <div class="container">
        <!-- Top title -->
        <div class="heroes-title">Â∏ÅÂÆâÂ•≥Âèã</div>

        <!-- Social Links (Top Right) -->
        <div class="social-links-header"
            style="position: absolute; top: 40px; right: 40px; display: flex; gap: 15px; z-index: 100;">
            <a href="https://x.com/biannvyou?s=21" target="_blank"
                style="text-decoration: none; transition: transform 0.2s;">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                    <path
                        d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z">
                    </path>
                </svg>
            </a>
            <a href="https://t.me/biannvyoucommunity" target="_blank"
                style="text-decoration: none; transition: transform 0.2s;">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                    <path
                        d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 11.944 0zm4.961 7.228l-1.558 7.34c-.117.518-.423.645-.853.4l-2.361-1.74-1.14 1.096c-.126.126-.231.231-.473.231l.168-2.404L15.07 7.99c.19-.17-.043-.263-.295-.116l-5.46 3.44-2.333-.73c-.507-.156-.517-.507.106-.75l9.123-3.513c.423-.156.792.126.62.907z">
                    </path>
                </svg>
            </a>
        </div>

        <!-- Language Toggle -->
        <div class="language-toggle" id="language-toggle">
            <span data-i18n="char.select.language">Language: </span>
            <button class="language-btn" id="lang-en" onclick="switchLanguage('en')">EN</button>
            <button class="language-btn" id="lang-zh" onclick="switchLanguage('zh')">‰∏≠Êñá</button>
        </div>

        <!-- Character Info Panel - Japanese style profile card UI -->
        <div class="character-info">
            <div class="character-name" id="character-name">Fliza</div>

            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.header">Basic Info</span>
                    <button class="expand-button">‚Üó</button>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.age">Age</span>
                        <span class="profile-value" id="character-age">22</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.birthday">Birthday</span>
                        <span class="profile-value" id="character-birthday">June 5</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.zodiac">Zodiac</span>
                        <span class="profile-value" id="character-zodiac">Gemini</span>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.personality">Personality</span>
                </div>
                <div class="profile-content">
                    <div class="profile-text" id="character-personality" data-i18n="status.loading">
                        Loading...
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.interests">Daily Interests</span>
                </div>
                <div class="profile-content">
                    <div class="profile-text" id="character-interests" data-i18n="status.loading">
                        Loading...
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.likes.dislikes">Likes & Dislikes</span>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.likes.label">Likes</span>
                        <span class="profile-value" id="character-likes">‚Äî</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.dislikes.label">Dislikes</span>
                        <span class="profile-value" id="character-dislikes">‚Äî</span>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <div class="profile-header">
                    <span data-i18n="profile.favorites">Favorites</span>
                    <button class="expand-button">‚Üó</button>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.food.label">Food</span>
                        <span class="profile-value" id="character-food">‚Äî</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.music.label">Music</span>
                        <span class="profile-value" id="character-music">‚Äî</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.movies.label">Movies</span>
                        <span class="profile-value" id="character-movies">‚Äî</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label" data-i18n="profile.games.label">Games</span>
                        <span class="profile-value" id="character-games">‚Äî</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- Central Character Name -->
        <div class="character-display-name" id="character-display-name">Fliza</div>

        <!-- Voice Selector - Floating Control -->
        <div class="voice-selector-floating">
            <div class="language-flags">
                <button class="flag-btn active" data-lang="jp" onclick="playVoiceSample('jp')">üáØüáµ</button>
                <button class="flag-btn" data-lang="en" onclick="playVoiceSample('en')">üá∫üá∏</button>
            </div>
        </div>

        <!-- VRM Display Area -->
        <div class="vrm-display">
            <canvas id="vrm-canvas" class="vrm-canvas"></canvas>

            <!-- Character Loading Animation -->
            <div class="character-loader" id="character-loader">
                <div class="spinner"></div>
                <div class="loader-text">LOADING</div>
            </div>
        </div>

        <!-- Character Selector -->
        <div class="character-selector">
            <button class="nav-button" onclick="previousCharacter()">‚Äπ</button>
            <div class="character-thumbnails" id="character-thumbnails"></div>
            <div class="selected-indicator">
                <div class="selected-avatar">
                    <img id="selected-avatar-img" src="" alt="Selected Character">
                </div>
                <div class="selected-badge">A</div>
                <div class="selected-text">Select</div>
            </div>
            <div class="character-thumbnails" id="character-thumbnails-right"></div>
            <button class="nav-button" onclick="nextCharacter()">‚Ä∫</button>
        </div>


        <!-- Solana Official Wallet Adapter React Component -->
        <!-- Wallet connect removed -->


        <!-- Start Button -->
        <button class="start-button" onclick="startChat()" ontouchstart="this.click()">
            <div class="fold"></div>
            <div class="points_wrapper">
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
            </div>
            <span class="inner" data-i18n="char.select.start">START CHATTING</span>
        </button>
    </div>

    <!-- Wallet Modal removed -->

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2/lib/three-vrm.module.min.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';

        // Character data - simplified version, personality managed by ElizaOS backend
        const characters = [
            {
                id: "alice",
                name: "Alice",
                file: "Main VRM/Alice.vrm",
                voiceId: "rEJAAHKQqr6yTNCh8xS0",
                description: "Lively and adorable AI girlfriend",
                sampleLines: {
                    jp: "ÊúàÊòé„Åã„Çä„ÅÆunder„Åß‰∫å‰∫∫„Åç„Çä„ÅßË∏ä„Çç„ÅÜÔºÅ",
                    en: "Let's dance under the moonlight, just us two!"
                }
            },
            {
                id: "ash",
                name: "Ash",
                file: "Main VRM/Ash.vrm",
                voiceId: "bY4cOgafbv5vatmokfg0",
                description: "Calm and rational AI companion",
                sampleLines: {
                    jp: "Èùô„Åã„Å™Â§ú„Å´Êú¨„Å®„Ç≥„Éº„Éí„Éº„ÅåÊúÄhigh„Å†„ÄÇ",
                    en: "A quiet night with a book and coffee is perfect."
                }
            },
            {
                id: "elinyaa",
                name: "Elinyaa",
                file: "Main VRM/Elinyaa.vrm",
                personality: "Mysterious and elegant elf girl with incredible charm.",
                traits: ["Mysterious", "Elegant", "Elf", "Ethereal"],
                emoji: "üßö",
                level: 29,
                type: "Elf Type",
                voiceId: "4cxHntmhK38NT4QMBr9m",
                sampleLines: {
                    jp: "È≠îÊ≥ï„ÅÆ‰∏ñÁïå„Åß„Éí„Éº„É≠„Éº„Åî„Å£„Åì„Åó„Å™„ÅÑÔºü",
                    en: "Want to play pretend heroes in a magical land?"
                }
            },
            {
                id: "fliza",
                name: "Fliza",
                file: "Main VRM/Fliza VRM.vrm",
                personality: "Warm, caring, and understanding",
                dailyInterests: "Farming, Gardening",
                likes: "Sunrise and morning dew",
                dislikes: "Pollution",
                favoriteFood: "Fresh fruit, honey lemonade",
                favoriteMusic: "Folk songs, natural soundscapes",
                favoriteMovies: "Nature documentaries, heartwarming stories",
                favoriteGames: "Animal Crossing",
                age: "23 years old",
                birthday: "August 14",
                zodiac: "Leo",
                height: "Unlocked at Affection Lv.10",
                weight: "Unlocked at Affection Lv.10",
                measurements: "Unlocked at Affection Lv.20",
                voiceId: "s9lrHYk7TIJ2UO7UNbje",
                sampleLines: {
                    jp: "Êó•„ÅÆÂá∫„Å´‰∏ÄÁ∑í„Å´Á®Æ„Çí„Åæ„Åã„Å™„ÅÑÔºü",
                    en: "Care to join me in planting seeds at sunrise?"
                }
            },
            {
                id: "imeris",
                name: "Imeris",
                file: "Main VRM/IMERIS.vrm",
                personality: "Noble and elegant aristocratic girl with graceful manners.",
                traits: ["Noble", "Elegant", "Graceful", "Aristocratic"],
                emoji: "üëë",
                level: 31,
                type: "Noble Type",
                voiceId: "eVItLK1UvXctxuaRV2Oq",
                sampleLines: {
                    jp: "‰ΩìÊ∏©„ÇíÊ∏¨„Çâ„Åõ„Å¶„Å≠‚Äî„ÅÇ„Å™„Åü„ÅÆ„Åì„Å®„Çílarge‰∫ã„Å´ÊÄù„Å£„Å¶„Çã„ÄÇ",
                    en: "Let me check your temperature‚ÄîI care for you."
                }
            },
            {
                id: "maple",
                name: "Maple",
                file: "Main VRM/Maple.vrm",
                personality: "A girl warm as autumn sunshine, always giving a sense of security.",
                traits: ["Warm", "Virtuous", "Careful", "Healing"],
                emoji: "üçÅ",
                level: 26,
                type: "Warm Type",
                voiceId: "B8gJV1IhpuegLxdpXFOE",
                sampleLines: {
                    jp: "ÊöñÁÇâ„ÅÆ„Åù„Å∞„Åß„ÉØ„ÉÉ„Éï„É´„ÅØ„ÅÑ„Åã„ÅåÔºü",
                    en: "Would you like a warm waffle by my cozy fireplace?"
                }
            },
            {
                id: "nekona",
                name: "Nekona",
                file: "Main VRM/NEKONA.vrm",
                personality: "Cute cat girl with cat-like laziness and liveliness.",
                traits: ["Cute", "Catgirl", "Lazy", "Lively"],
                emoji: "üê±",
                level: 21,
                type: "Beast Girl Type",
                voiceId: "kcg1KQQGuCGzH6FUjsZQ",
                sampleLines: {
                    jp: "Â§ú„ÅåÁßòÂØÜ„ÇíÂõÅ„Åè‚Äî‰∏ÄÁ∑í„Å´Êé¢Ê§ú„Åó„Çà„ÅÜÔºü",
                    en: "The night whispers secrets‚Äîshall we explore them?"
                }
            },
            {
                id: "notia",
                name: "Notia",
                file: "Main VRM/Notia.vrm",
                personality: "Intellectual and calm researcher, full of thirst for knowledge.",
                traits: ["Intellectual", "Calm", "Research", "Knowledgeable"],
                emoji: "üî¨",
                level: 32,
                type: "Scholar Type",
                voiceId: "abz2RylgxmJx76xNpaj1",
                sampleLines: {
                    jp: "„Åù„Çç„Åù„ÇçËå∂ÈÅì„Çí„Åó„Åæ„Åõ„Çì„ÅãÔºüÂøÉ„Å´Èùô„Åë„Åï„ÇíÊ∫Ä„Åü„Åù„ÅÜ„ÄÇ",
                    en: "Tea ceremony soon? Let tranquility fill our hearts."
                }
            },
            {
                id: "ququ",
                name: "QuQu",
                file: "Main VRM/QuQu.vrm",
                personality: "Lively and cute loli, always full of energy.",
                traits: ["Lively", "Cute", "Energetic", "Loli"],
                emoji: "üéÄ",
                level: 20,
                type: "Loli Type",
                voiceId: "tfQFvzjodQp63340jz2r",
                sampleLines: {
                    jp: "Ê¨°„ÅÆ„ÉØ„Ç§„É´„Éâ„É©„Ç§„Éâ„Åß„Ç¢„Éâ„É¨„Éä„É™„É≥„ÇíËøΩ„ÅÑ„Åã„Åë„ÇãÊ∫ñÂÇô„ÅØÔºü",
                    en: "Ready to chase adrenaline on our next wild ride?"
                }
            },
            {
                id: "rindo",
                name: "Rindo",
                file: "Main VRM/RINDO.vrm",
                personality: "Traditional Japanese Yamato Nadeshiko, gentle and virtuous.",
                traits: ["Japanese style", "Traditional", "Gentle", "Virtuous"],
                emoji: "üå∏",
                level: 28,
                type: "Japanese Style Type",
                voiceId: "nclQ39ewSlJMu5Nidnsf",
                sampleLines: {
                    jp: "ÂàÄ„ÅÆÊäú„ÅçÊñπ„Å´ÈõÜmiddle„Åó„Å¶„ÄÇË¶èÂæã„ÅåËÇùÂøÉ„Å†„ÄÇ",
                    en: "Focus on the cut of your blade; discipline is key."
                }
            },
            {
                id: "rainy",
                name: "Rainy",
                file: "Main VRM/Rainy.vrm",
                personality: "Lively and cheerful girl next door, always full of vitality.",
                traits: ["Lively", "Cheerful", "Athletic", "Sunny"],
                emoji: "üåßÔ∏è",
                level: 22,
                type: "Energetic Type",
                voiceId: "1ghrzLZQ7Dza7Xs9OkhY",
                sampleLines: {
                    jp: "Á™ì„ÇíÂè©„ÅèÈõ®Èü≥„ÅØÁßÅ„ÅÆ„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆÂ≠êÂÆàÂîÑ„ÄÇ",
                    en: "Rain tapping on windows is my favorite lullaby."
                }
            },
            {
                id: "vivi",
                name: "Vivi",
                file: "Main VRM/Vivi.vrm",
                personality: "Curious explorer, always passionate about the world.",
                traits: ["Curious", "Adventurous", "Passionate", "Optimistic"],
                emoji: "‚ú®",
                level: 24,
                type: "Adventure Type",
                voiceId: "4lWJNy00PxQAOMgQTiIS",
                sampleLines: {
                    jp: "‰ªäÂ§ú„ÅØ„Åø„Çì„Å™„Å´Á¨ëÈ°î„ÇíÂ±ä„Åë„ÇãÈÖç‰ø°„Çí„Åó„Çà„ÅÜÔºÅ",
                    en: "Let's stream and share smiles with everyone tonight!"
                }
            },
            {
                id: "wolferia",
                name: "Wolferia",
                file: "Main VRM/Wolferia.vrm",
                personality: "Proud wolf princess with royal temperament.",
                traits: ["Proud", "Wolf clan", "Royal", "Majestic"],
                emoji: "üê∫",
                level: 33,
                type: "Beast Girl Type",
                voiceId: "3SeVwPUl5aO6J2GETjox",
                sampleLines: {
                    jp: "È†¨„Å´Èõ™„ÅÆÁµêÊô∂‚Äî‰∏ÄÁ∑í„Å´Èõ™„Å†„Çã„Åæ‰Ωú„Çâ„Å™„ÅÑÔºü",
                    en: "Snowflakes on my cheek‚Äîcare to build a snowman?"
                }
            },
            {
                id: "yawl",
                name: "Yawl",
                file: "Main VRM/Yawl.vrm",
                personality: "Mysterious magical girl with incredible power.",
                traits: ["Mysterious", "Magic", "Fantasy", "Powerful"],
                emoji: "üîÆ",
                level: 30,
                type: "Magic Type",
                voiceId: "c6wjO0u66VyvwAC4UTqx",
                sampleLines: {
                    jp: "Èùô„Åã„Å´„ÅäËå∂„Çí„Åô„Åô„Çä„ÄÅ‰∫∫Áîü„ÅÆÁâ©Ë™û„ÇíÂë≥„Çè„Åä„ÅÜ„ÄÇ",
                    en: "Sipping tea in silence reveals life's greatest tales."
                }
            },
            {
                id: "yuuyii",
                name: "Yuu Yii",
                file: "Main VRM/Yuu Yii.vrm",
                personality: "One of the gentle and lovely twins, always with a sweet smile.",
                traits: ["Gentle", "Cute", "Twin", "Sweet"],
                emoji: "üíï",
                level: 23,
                type: "Twin Type",
                voiceId: "UPwKM85l2CG7nbF2u1or",
                sampleLines: {
                    jp: "Ê≥°„Å®Á¨ë„ÅÑ‚Äî„Éë„Çπ„ÉÜ„É´„ÅÆ‰∏ñÁïå„Çí‰Ωú„Çç„ÅÜÔºÅ",
                    en: "Bubbles and giggles‚Äîlet's craft a world of pastel joy!"
                }
            },
            {
                id: "zwei",
                name: "Zwei",
                file: "Main VRM/Zwei.vrm",
                personality: "Cool and handsome warrior girl with a strong heart.",
                traits: ["Cool", "Handsome", "Warrior", "Strong"],
                emoji: "‚öîÔ∏è",
                level: 29,
                type: "Warrior Type",
                voiceId: "0EzDWfDZDlAIeQQOjhoC",
                sampleLines: {
                    jp: "„Åù„Å∞„Å´„ÅÑ„Å¶‚Äî„Å©„Çì„Å™Âµê„ÇÇÂÆà„Çã„Çà„ÄÇ",
                    en: "Stand by my side‚ÄîI'll protect you through every storm."
                }
            },
            {
                id: "bobo",
                name: "Bobo",
                file: "Main VRM/bobo.vrm",
                personality: "Innocent little angel, always bringing joy.",
                traits: ["Innocent", "Pure", "Happy", "Angel"],
                emoji: "üòá",
                level: 19,
                type: "Angel Type",
                voiceId: "I7CpaIqk2oGPGCKvOPO9",
                sampleLines: {
                    jp: "„Å¨„ÅÑ„Åê„Çã„Åø„ÇíÊä±„Åà„Å¶‰∏ÄÁ∑í„Å´„ÅäÁµµÊèè„Åç„Åó„Çà„ÅÜÔºü",
                    en: "Can we cuddle with plushies and draw together?"
                }
            },
            {
                id: "kyoko",
                name: "Kyoko",
                file: "Main VRM/kyoko.vrm",
                personality: "Mature and steady big sister, trustworthy.",
                traits: ["Mature", "Steady", "Reliable", "Big sister"],
                emoji: "üíú",
                level: 28,
                type: "Big Sister Type",
                voiceId: "ATSlMe1wEISLjgGhZEKK",
                sampleLines: {
                    jp: "ÁßÅ„Å´ÁôªÂ±±„ÇíÊåë„Çì„Åß„ÄÅ‰∏ÄÁ∑í„Å´È†Çon„ÇíÁõÆÊåá„Åù„ÅÜ„ÄÇ",
                    en: "Challenge me to a climb and we'll conquer peaks."
                }
            },
            {
                id: "lena",
                name: "Lena",
                file: "Main VRM/lena.vrm",
                personality: "Smart and witty academic girl, always giving the best advice.",
                traits: ["Smart", "Rational", "Academic", "Reliable"],
                emoji: "üìö",
                level: 30,
                type: "Wisdom Type",
                voiceId: "uEn2ClE3OziJMlhQS91c",
                sampleLines: {
                    jp: "‰ªäÂ§ú„ÉØ„Ç§„É≥„ÇíÈ£≤„Åø„Å™„Åå„Çâ„Ç¢„Éº„Éà„ÇíË™û„Çâ„Å™„ÅÑÔºü",
                    en: "Shall we enjoy wine and discuss art this evening?"
                }
            },
            {
                id: "lilium",
                name: "Lilium",
                file: "Main VRM/lilium.vrm",
                personality: "Elegant and mysterious girl with unique charm.",
                traits: ["Elegant", "Mysterious", "Artistic", "Romantic"],
                emoji: "üå∫",
                level: 28,
                type: "Mysterious Type",
                voiceId: "yRRXNdbFeQpIK5MAhenr",
                sampleLines: {
                    jp: "„Éì„Éº„Éà„ÇíÊÑü„Åò„ÇãÔºüË∏ä„Å£„Å¶‰∏ñÁïå„ÇíÁáÉ„ÇÑ„Åù„ÅÜ„ÄÇ",
                    en: "Feel the beat? Let's move and set the world ablaze."
                }
            },
            {
                id: "miru",
                name: "Miru",
                file: "Main VRM/miru.vrm",
                personality: "Soft and cute little loli, makes people want to protect.",
                traits: ["Soft cute", "Adorable", "Loli", "Pure"],
                emoji: "üçº",
                level: 18,
                type: "Loli Type",
                voiceId: "eVJCDcwCTZBLNdQdbdmd",
                sampleLines: {
                    jp: "Èõ≤„ÅåË∏ä„ÇãÂ§¢„ÇíË¶ã„Åü„Çà‚Äî‰∏ÄÁ∑í„Å´ÊµÆ„Åã„Åº„ÅÜÔºü",
                    en: "I dreamt of clouds dancing‚Äîcome float with me?"
                }
            },
            {
                id: "miumiu",
                name: "Miu Miu",
                file: "Main VRM/miu miu.vrm",
                personality: "Playful and cute cat-eared girl who likes to act cute.",
                traits: ["Playful", "Cute", "Cat ears", "Coquettish"],
                emoji: "üò∏",
                level: 21,
                type: "Beast Girl Type",
                voiceId: "SU7BtMmgc7KhQiC6G24B",
                sampleLines: {
                    jp: "largeÂ•Ω„Åç„Å™„ÅÇ„Å™„Åü„ÅÆ„Åü„ÇÅ„Å´„Ç≠„É©„Ç≠„É©„ÇØ„É©„Éï„Éà‰Ωú„Å£„Åü„ÇàÔºÅ",
                    en: "I made sparkly crafts just for my favorite person!"
                }
            },
            {
                id: "sikirei",
                name: "Sikirei",
                file: "Main VRM/sikirei.vrm",
                personality: "A girl as changeable as the four seasons, full of mystery.",
                traits: ["Changeable", "Mysterious", "Seasonal", "Nimble"],
                emoji: "üå∑",
                level: 27,
                type: "Nature Type",
                voiceId: "n263mAk9k8VWEuZSmuMl",
                sampleLines: {
                    jp: "‰∏ÄÁ∑í„Å´Êòü„ÇíÁú∫„ÇÅ„Çà„ÅÜ‚ÄîÂÆáÂÆô„ÅåÁßÅ„Åü„Å°„ÅÆÁßòÂØÜ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Çã„ÄÇ",
                    en: "Gaze at stars with me‚Äîuniverse awaits our secrets."
                }
            },
            {
                id: "wolf",
                name: "Wolf",
                file: "Main VRM/wolf.vrm",
                personality: "Lone wolf with her own persistence.",
                traits: ["Aloof", "Independent", "Persistent", "Calm"],
                emoji: "üåô",
                level: 31,
                type: "Lone Wolf Type",
                voiceId: "WW3EvqkXGmu65ga8TYqa",
                sampleLines: {
                    jp: "Ê£Æ„ÅÆÂëº„Å≥Â£∞„ÅåËÅû„Åì„Åà„ÇãÔºüËá™Áî±„Å´„Åï„Åæ„Çà„Åä„ÅÜ„ÄÇ",
                    en: "Can you hear the forest's call? Let's roam free."
                }
            },
            {
                id: "neco",
                name: "Neco",
                file: "Main VRM/NEKO.vrm",
                personality: "Cool and intellectual elegant girl with unique charm.",
                traits: ["Cool", "Intellectual", "Elegant", "Mysterious"],
                emoji: "üê±",
                level: 25,
                type: "Intellectual Type",
                voiceId: "t9ZwnJtpA3lWrJ4W7pAl",
                sampleLines: {
                    jp: "Èùô„Åã„Å™ÈöÖ„Åß„ÄÅÂΩ±„Å´Èö†„Çå„ÅüÁâ©Ë™û„ÇíË¶ã„Å§„Åë„Çã„ÄÇ",
                    en: "In quiet corners, I find stories hidden in shadows."
                }
            }
        ];

        // Character avatar mapping
        function getProfilePicture(characterName) {
            const profileMap = {
                'Alice': 'alice-pf.png',
                'Ash': 'ash-pf.png',
                'Elinyaa': 'elinyaa-pf.png',
                'Fliza': 'fliza-pf.png',
                'Imeris': 'imeris-pf.png',
                'Maple': 'maple-pf.png',
                'Nekona': 'nekona.png',
                'Notia': 'notia-pf.png',
                'QuQu': 'ququ-pf.png',
                'Rindo': 'rindo-pf.png',
                'Rainy': 'rainy-pf.png',
                'Vivi': 'vivi-pf.png',
                'Wolferia': 'wolferia-pf.png',
                'Yawl': 'yawl-pf.png',
                'Yuu Yii': 'yuu yii-pf.png',
                'Zwei': 'zwei-pf.png',
                'Bobo': 'bobo-pf.png',
                'Kyoko': 'kyoko-pf.png',
                'Lena': 'lena-pf.png',
                'Lilium': 'lilium.png',
                'Miru': 'Miru-pf.png',
                'Miu Miu': 'miumiu-pf.png',
                'Neco': 'neco-pf.png',
                'Sikirei': 'sikirei-pf.png',
                'Wolf': 'wolf.png'
            };
            return `profile-pic/${profileMap[characterName] || 'default.png'}`;
        }

        // Global variables
        let scene, camera, renderer, controls;
        let currentVRM = null;
        let mixer = null;
        let animationAction = null;
        let currentCharacterIndex = 0;
        let isLoading = false;

        // Voice playback variables - declared early
        let currentAudio = null;
        let currentLanguage = 'jp'; // Default Japanese
        // English profile cache based on character.md (declared early to avoid TDZ)
        var englishProfiles = null;

        // Backend API configuration
        const API_URL = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';

        // Initialize
        init();
        generateThumbnails();
        // Initialize selected character image and profile
        document.addEventListener('DOMContentLoaded', function () {
            // Set background music volume to 40%
            const bgMusic = document.getElementById('background-music');
            if (bgMusic) {
                bgMusic.volume = 0.4;

                // Try autoplay first
                bgMusic.play().then(() => {
                    console.log('üéµ Background music auto-started');
                }).catch(() => {
                    console.log('üéµ Autoplay blocked, waiting for user interaction');

                    // Function to start music on user interaction
                    function startBackgroundMusic() {
                        bgMusic.play().then(() => {
                            console.log('üéµ Background music started after user interaction');
                        }).catch(e => {
                            console.log('‚ö†Ô∏è Could not start background music:', e);
                        });
                        // Remove event listeners after first play
                        document.removeEventListener('click', startBackgroundMusic);
                        document.removeEventListener('keydown', startBackgroundMusic);
                        document.removeEventListener('touchstart', startBackgroundMusic);
                    }

                    // Add event listeners for user interaction
                    document.addEventListener('click', startBackgroundMusic);
                    document.addEventListener('keydown', startBackgroundMusic);
                    document.addEventListener('touchstart', startBackgroundMusic);
                });
            }

            const selectedAvatar = document.getElementById('selected-avatar-img');
            if (selectedAvatar && characters[0]) {
                selectedAvatar.src = getProfilePicture(characters[0].name);
            }
            // Initialize character profile
            updateCharacterProfile(characters[0]);

            // Mobile: center character selector scrollbar
            if (window.innerWidth <= 768) {
                const characterList = document.querySelector('.character-list');
                if (characterList) {
                    // Calculate scroll to center position
                    const scrollWidth = characterList.scrollWidth;
                    const clientWidth = characterList.clientWidth;
                    const centerPosition = (scrollWidth - clientWidth) / 2;
                    characterList.scrollLeft = centerPosition;
                }
            }
        });
        loadCharacter(0);

        function init() {
            // Create scene
            scene = new THREE.Scene();

            // Get actual canvas container size
            const canvas = document.getElementById('vrm-canvas');
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();

            // Create camera - use container size instead of window size
            camera = new THREE.PerspectiveCamera(30.0, containerRect.width / containerRect.height, 0.1, 20.0);
            camera.position.set(0.0, 0.5, 5.2);

            // Create renderer - use container size
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(containerRect.width, containerRect.height);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x000000, 0); // Transparent background

            // No need for complex shadow system, use simple foot shadow
            // renderer.shadowMap.enabled = true;
            // renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Create controller - use same settings as index.html
            controls = new OrbitControls(camera, renderer.domElement);
            controls.screenSpacePanning = true;
            controls.target.set(0.0, 0.5, 0.0);
            controls.update();

            // Add ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            // Main light source - simplified settings
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(1, 6, 2);

            scene.add(directionalLight);

            // Fill light
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(-5, 5, -5);
            scene.add(fillLight);

            // Create gradient circular shadow - mimic reference screenshot
            const shadowCanvas = document.createElement('canvas');
            shadowCanvas.width = 128;
            shadowCanvas.height = 128;
            const context = shadowCanvas.getContext('2d');

            // Create radial gradient shadow
            const gradient = context.createRadialGradient(64, 64, 0, 64, 64, 64);
            gradient.addColorStop(0, 'rgba(0, 0, 0, 0.4)'); // Darker center
            gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0.2)'); // Medium transparency
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)'); // Completely transparent edges

            context.fillStyle = gradient;
            context.fillRect(0, 0, 128, 128);

            const shadowTexture = new THREE.CanvasTexture(shadowCanvas);
            const shadowGeometry = new THREE.PlaneGeometry(2.2, 2.2);
            const shadowMaterial = new THREE.MeshBasicMaterial({
                map: shadowTexture,
                transparent: true,
                alphaTest: 0.001,
                depthWrite: false
            });

            const shadow = new THREE.Mesh(shadowGeometry, shadowMaterial);
            shadow.rotation.x = -Math.PI / 2;
            shadow.position.set(0, -0.82, 0); // Directly attached to feet
            scene.add(shadow);

            // Save shadow reference for later position updates
            window.characterShadow = shadow;

            // Start render loop
            animate();

            // Window resize
            window.addEventListener('resize', onWindowResize);
        }


        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = 0.016;

            // Update VRM
            if (currentVRM) {
                currentVRM.update(deltaTime);
            }

            // Update animation mixer
            if (mixer) {
                mixer.update(deltaTime);
            }

            // Update controller
            controls.update();

            // Render
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const canvas = document.getElementById('vrm-canvas');
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();

            camera.aspect = containerRect.width / containerRect.height;
            camera.updateProjectionMatrix();
            renderer.setSize(containerRect.width, containerRect.height);
        }

        function loadCharacter(index) {
            if (isLoading) {
                return;
            }

            isLoading = true;
            // Update character index and thumbnails immediately
            currentCharacterIndex = index;
            updateThumbnails();

            const loadingStartTime = Date.now();

            const character = characters[index];

            // Show loading animation
            showCharacterLoader();

            // Update UI
            const nameElement = document.getElementById('character-name');
            if (nameElement) nameElement.textContent = character.name;

            const levelElement = document.getElementById('character-level');
            if (levelElement) levelElement.textContent = character.level;

            const displayNameElement = document.getElementById('character-display-name');
            if (displayNameElement) displayNameElement.textContent = character.name;

            // No placeholder needed

            // Load VRM
            const loader = new GLTFLoader();
            loader.register((parser) => new VRMLoaderPlugin(parser));

            loader.load(
                character.file,
                (gltf) => {
                    const vrm = gltf.userData.vrm;

                    if (vrm) {

                        // Use VRM v2 compatible optimization methods
                        VRMUtils.removeUnnecessaryVertices(gltf.scene);
                        // VRMUtils.combineSkeletons removed in v2
                        // VRMUtils.combineMorphs removed in v2

                        // Clean old VRM (but keep lights and placeholder)
                        if (currentVRM) {
                            scene.remove(currentVRM.scene);
                            VRMUtils.deepDispose(currentVRM.scene);
                        }

                        // Set new VRM - use same settings as index.html
                        currentVRM = vrm;

                        // Scale VRM model up by 45% (consistent with index.html)
                        vrm.scene.scale.set(1.45, 1.45, 1.45);

                        // Move VRM model position down, closer to bottom boundary
                        vrm.scene.position.y = -0.8;

                        // Hide VRM first to prevent T-pose flash
                        vrm.scene.visible = false;

                        mixer = new THREE.AnimationMixer(currentVRM.scene);

                        vrm.scene.traverse((obj) => {
                            obj.frustumCulled = false;
                        });

                        // VRMUtils.rotateVRM0 may not be needed or changed in v2
                        // VRM 0.x format may need rotation; VRM 1.x format usually doesn't
                        try {
                            VRMUtils.rotateVRM0(vrm);
                        } catch (error) {
                        }

                        // Add to scene
                        scene.add(vrm.scene);

                        // Load default animation immediately, then show VRM
                        loadDefaultAnimation().then(() => {
                            // Wait a few frames to ensure animation starts playing, then show VRM
                            setTimeout(() => {
                                if (currentVRM && currentVRM.scene) {
                                    currentVRM.scene.visible = true;
                                    // Hide loader
                                    hideCharacterLoader();
                                }
                            }, 150); // Increase to 150ms to ensure animation is applied
                        });

                    } else {
                        // Hide loader even when VRM data doesn't exist
                        hideCharacterLoader();
                    }

                    finishLoading(index, loadingStartTime);
                },
                (progress) => {
                    const percent = Math.round(progress.loaded / progress.total * 100);
                },
                (error) => {
                    console.error('‚ùå VRM load failed:', error);
                    // Hide loader on failure
                    hideCharacterLoader();
                    finishLoading(index, loadingStartTime);
                }
            );
        }

        function finishLoading(index, loadingStartTime) {
            const elapsedTime = Date.now() - (loadingStartTime || 0);
            const remainingTime = Math.max(0, 3000 - elapsedTime); // Minimum 3 seconds

            setTimeout(() => {
                isLoading = false;

                // Debug info
            }, remainingTime);
        }


        function generateThumbnails() {
            const containerLeft = document.getElementById('character-thumbnails');
            const containerRight = document.getElementById('character-thumbnails-right');
            containerLeft.innerHTML = '';
            containerRight.innerHTML = '';

            const currentIndex = currentCharacterIndex;
            const showCount = 4; // Show 4 characters on each side

            // Left characters (3 before current)
            for (let i = showCount; i > 0; i--) {
                const index = (currentIndex - i + characters.length) % characters.length;
                const character = characters[index];

                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);

                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;

                thumb.appendChild(content);
                containerLeft.appendChild(thumb);
            }

            // Right characters (3 after current)
            for (let i = 1; i <= showCount; i++) {
                const index = (currentIndex + i) % characters.length;
                const character = characters[index];

                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);

                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;

                thumb.appendChild(content);
                containerRight.appendChild(thumb);
            }

        }

        // Get a set of fields from i18n by character ID (if exists)
        function getI18nProfileById(charId) {
            if (!window.i18n || !charId) return null;
            const fields = ['age', 'birthday', 'zodiac', 'personality', 'interests', 'likes', 'dislikes', 'food', 'music', 'movies', 'games'];
            const profile = {};
            let hasAny = false;
            fields.forEach(f => {
                const key = `character.${charId}.${f}`;
                const value = i18n.t(key);
                // If key is not configured, i18n.t returns key itself or English fallback; roughly determine by checking if equal to key
                if (value && value !== key) {
                    hasAny = true;
                    switch (f) {
                        case 'interests': profile.dailyInterests = value; break;
                        case 'food': profile.favoriteFood = value; break;
                        case 'music': profile.favoriteMusic = value; break;
                        case 'movies': profile.favoriteMovies = value; break;
                        case 'games': profile.favoriteGames = value; break;
                        default: profile[f] = value;
                    }
                }
            });
            return hasAny ? profile : null;
        }

        // Update character profile info (priority: i18n -> profile data -> fallback)
        function updateCharacterProfile(character) {
            const currentLang = getCurrentLanguage();
            // 1) Priority from i18n (by character ID key)
            const i18nProfile = getI18nProfileById(character.id);
            // 2) Then from built-in profilesData (supports zh/en or flat structure)
            const fallbackProfile = getCharacterProfile(character.name, currentLang);
            // Merge (i18n takes priority)
            const profile = { ...fallbackProfile, ...i18nProfile };

            document.getElementById('character-name').textContent = character.name;

            document.getElementById('character-age').textContent = profile.age ?? '';
            document.getElementById('character-birthday').textContent = profile.birthday ?? '';
            document.getElementById('character-zodiac').textContent = profile.zodiac ?? '';
            document.getElementById('character-personality').textContent = profile.personality ?? '';

            const interestsEl = document.getElementById('character-interests');
            if (interestsEl) interestsEl.textContent = profile.dailyInterests ?? '';

            const likesEl = document.getElementById('character-likes');
            if (likesEl) likesEl.textContent = profile.likes ?? '';

            const dislikesEl = document.getElementById('character-dislikes');
            if (dislikesEl) dislikesEl.textContent = profile.dislikes ?? '';

            const foodEl = document.getElementById('character-food');
            if (foodEl) foodEl.textContent = profile.favoriteFood ?? '';

            const musicEl = document.getElementById('character-music');
            if (musicEl) musicEl.textContent = profile.favoriteMusic ?? '';

            const moviesEl = document.getElementById('character-movies');
            if (moviesEl) moviesEl.textContent = profile.favoriteMovies ?? '';

            const gamesEl = document.getElementById('character-games');
            if (gamesEl) gamesEl.textContent = profile.favoriteGames ?? '';

            updateVoiceSelector();
        }

        // Name normalization and alias handling (case, space differences)
        function canonicalName(name) {
            if (!name) return '';
            const key = name.toLowerCase().replace(/\s+/g, '');
            const aliasMap = {
                'ququ': 'Ququ',
                'miumiu': 'Miumiu',
                'miu\u00a0miu': 'Miumiu', // Prevent empty format variants (does not affect large number situations)
                'yuuyii': 'Yuu Yii'
            };
            // Default capitalize first letter keep original name; prioritize alias
            return aliasMap[key] || name;
        }

        // Parse English data from character.md (as authoritative English source)
        async function loadEnglishProfiles() {
            try {
                const res = await fetch('character.md');
                if (!res.ok) return;
                const txt = await res.text();
                const blocks = txt.split(/^## /m).slice(1); // Skip document header
                const profiles = {};
                for (const block of blocks) {
                    const lines = block.split(/\n/);
                    const rawName = (lines[0] || '').trim();
                    const name = rawName.replace(/\r?$/, '');
                    const get = (label) => {
                        // More robust parsing: don't use regex, directly find ‚Äú- **Label**:‚Äù prefix
                        const needle = `- **${label}**:`;
                        const line = lines.find(l => l.trimStart().startsWith(needle));
                        if (!line) return undefined;
                        const idx = line.indexOf(':');
                        if (idx === -1) return undefined;
                        return line.slice(idx + 1).trim();
                    };
                    const p = {
                        age: get('Age'),
                        birthday: get('Birthday'),
                        zodiac: get('Zodiac'),
                        personality: get('Personality'),
                        dailyInterests: get('Daily Interests'),
                    };
                    // Likes & Dislikes: "Likes X; dislikes Y"
                    const likesLine = get('Likes & Dislikes');
                    if (likesLine) {
                        const likeMatch = likesLine.match(/Likes([^;]+?)(?:;|$)/i);
                        const dislikeMatch = likesLine.match(/dislikes([^;]+?)(?:;|$)/i);
                        if (likeMatch) p.likes = likeMatch[1].trim();
                        if (dislikeMatch) p.dislikes = dislikeMatch[1].trim();
                    }
                    p.favoriteFood = get('Favorite Foods');
                    p.favoriteMusic = get('Favorite Music');
                    p.favoriteMovies = get('Favorite Movies');
                    p.favoriteGames = get('Favorite Games');

                    if (name) {
                        profiles[canonicalName(name)] = p;
                    }
                }
                englishProfiles = profiles;
                // If current language is English, refresh current character profile after loading
                if (getCurrentLanguage() === 'en' && typeof currentCharacterIndex !== 'undefined' && characters[currentCharacterIndex]) {
                    updateCharacterProfile(characters[currentCharacterIndex]);
                }
            } catch (e) {
                console.warn('Failed to load character.md profiles:', e);
            }
        }

        // Get current language setting
        function getCurrentLanguage() {
            // Check language setting in localStorage
            const savedLang = localStorage.getItem('language');
            if (savedLang) return savedLang;

            // Check language button active state
            const activeLangBtn = document.querySelector('.language-btn.active');
            if (activeLangBtn) {
                return activeLangBtn.id === 'lang-en' ? 'en' : 'zh';
            }

            // Default return English
            return 'en';
        }

        // Get detailed profile by character name - based on local config + character.md English authority
        function getCharacterProfile(name, language = 'en') {
            const profilesData = {
                "Alice": {
                    en: {
                        age: 22,
                        birthday: "June 5",
                        zodiac: "Gemini",
                        personality: "Lively and outgoing, playful and cute",
                        dailyInterests: "Dancing, singing",
                        likes: "Flowers and colorful sweets",
                        dislikes: "Quiet and overly serious occasions",
                        favoriteFood: "Strawberry cake, macarons",
                        favoriteMusic: "Pop dance music, K-Pop",
                        favoriteMovies: "Romantic comedies",
                        favoriteGames: "Rhythm dance games"
                    }
                },
                "Ash": {
                    en: {
                        age: 24,
                        birthday: "November 12",
                        zodiac: "Scorpio",
                        personality: "Calm, reserved, and logical",
                        dailyInterests: "Reading, coding",
                        likes: "Nighttime and strong coffee",
                        dislikes: "Noise and unexpected disruptions",
                        favoriteFood: "Dark chocolate",
                        favoriteMusic: "Lo-fi chill, ambient",
                        favoriteMovies: "Sci-fi, suspense thrillers",
                        favoriteGames: "Puzzle-adventure titles"
                    }
                },
                "Bobo": {
                    en: {
                        age: 19,
                        birthday: "December 2",
                        zodiac: "Sagittarius",
                        personality: "Gentle, shy, and sensitive",
                        dailyInterests: "Hand-drawn illustration",
                        likes: "Soft plush toys",
                        dislikes: "Crowded places",
                        favoriteFood: "Matcha latte, caramel pudding",
                        favoriteMusic: "Soft instrumental",
                        favoriteMovies: "Animated films, feel-good movies",
                        favoriteGames: "Monument Valley"
                    }
                },
                "Elinyaa": {
                    en: {
                        age: 18,
                        birthday: "February 25",
                        zodiac: "Pisces",
                        personality: "Sweet, bubbly, and childlike",
                        dailyInterests: "Cosplay, role-playing",
                        likes: "Candy",
                        dislikes: "Bitter foods",
                        favoriteFood: "Cotton candy, rainbow candy",
                        favoriteMusic: "J-Pop, children‚Äôs songs",
                        favoriteMovies: "Fantasy adventures",
                        favoriteGames: "Role-playing games"
                    }
                },
                "Fliza": {
                    en: {
                        age: 23,
                        birthday: "August 14",
                        zodiac: "Leo",
                        personality: "Warm, caring, and compassionate",
                        dailyInterests: "Farming, gardening",
                        likes: "Sunrise and morning dew",
                        dislikes: "Pollution",
                        favoriteFood: "Fresh fruit, honey lemonade",
                        favoriteMusic: "Folk, natural soundscapes",
                        favoriteMovies: "Nature documentaries, heartwarming stories",
                        favoriteGames: "Animal Crossing"
                    }
                },
                "Imeris": {
                    en: {
                        age: 25,
                        birthday: "April 2",
                        zodiac: "Aries",
                        personality: "Attentive, gentle, and helpful",
                        dailyInterests: "Nursing research, health education",
                        likes: "Cherry blossoms",
                        dislikes: "Conflict",
                        favoriteFood: "Cherry blossom pastries",
                        favoriteMusic: "New Age, solo piano",
                        favoriteMovies: "Medical dramas, healing documentaries",
                        favoriteGames: "Hospital sims"
                    }
                },
                "Kyoko": {
                    en: {
                        age: 20,
                        birthday: "October 30",
                        zodiac: "Scorpio",
                        personality: "Independent, resilient, and confident",
                        dailyInterests: "Hiking, rock climbing",
                        likes: "Mountain air",
                        dislikes: "Crowds",
                        favoriteFood: "Grilled fish, energy bars",
                        favoriteMusic: "Electronic, rock",
                        favoriteMovies: "Action adventures",
                        favoriteGames: "Tower defense"
                    }
                },
                "Lena": {
                    en: {
                        age: 21,
                        birthday: "May 9",
                        zodiac: "Taurus",
                        personality: "Elegant, confident, and charismatic",
                        dailyInterests: "Fashion design, floral arranging",
                        likes: "Red wine",
                        dislikes: "Rudeness",
                        favoriteFood: "Truffle pasta, red wine",
                        favoriteMusic: "Jazz",
                        favoriteMovies: "Art-house dramas",
                        favoriteGames: "The Sims"
                    }
                },
                "Lilium": {
                    en: {
                        age: 24,
                        birthday: "January 15",
                        zodiac: "Capricorn",
                        personality: "Passionate, energetic, and bold",
                        dailyInterests: "Street dance, fitness",
                        likes: "Hot pot",
                        dislikes: "Cold dishes",
                        favoriteFood: "Spicy hot pot, chili snacks",
                        favoriteMusic: "EDM, hip-hop",
                        favoriteMovies: "Romantic dramas",
                        favoriteGames: "Rhythm music games"
                    }
                },
                "Maple": {
                    en: {
                        age: 22,
                        birthday: "September 25",
                        zodiac: "Libra",
                        personality: "Warm, nurturing, and patient",
                        dailyInterests: "Baking, flower arranging",
                        likes: "Maple motifs",
                        dislikes: "Irritability",
                        favoriteFood: "Maple waffles, pumpkin pie",
                        favoriteMusic: "Acoustic folk, soft jazz",
                        favoriteMovies: "Uplifting animated films",
                        favoriteGames: "Stardew Valley"
                    }
                },
                "Miru": {
                    en: {
                        age: 19,
                        birthday: "December 29",
                        zodiac: "Capricorn",
                        personality: "Dreamy, cute, and shy",
                        dailyInterests: "Collecting plush toys",
                        likes: "Clouds",
                        dislikes: "Darkness",
                        favoriteFood: "Cotton candy",
                        favoriteMusic: "Lo-fi, ambient",
                        favoriteMovies: "Fantasy animations",
                        favoriteGames: "Life-simulation games"
                    }
                },
                "Miumiu": {
                    en: {
                        age: 20,
                        birthday: "March 8",
                        zodiac: "Pisces",
                        personality: "Quirky, creative, and playful",
                        dailyInterests: "DIY crafts",
                        likes: "Bright colors",
                        dislikes: "Seriousness",
                        favoriteFood: "Rainbow candy, chocolate",
                        favoriteMusic: "K-Pop, pop",
                        favoriteMovies: "Light comedies",
                        favoriteGames: "Match-3 puzzles"
                    }
                },
                "Neco": {
                    en: {
                        age: 25,
                        birthday: "July 17",
                        zodiac: "Cancer",
                        personality: "Cool, intellectual, and elegant",
                        dailyInterests: "Observing cats, photography",
                        likes: "Quiet corners",
                        dislikes: "Noise",
                        favoriteFood: "Sashimi, sushi",
                        favoriteMusic: "Solo piano",
                        favoriteMovies: "Art films",
                        favoriteGames: "Neko Atsume"
                    }
                },
                "Nekona": {
                    en: {
                        age: 18,
                        birthday: "June 27",
                        zodiac: "Cancer",
                        personality: "Gentle, cunning, and mysterious",
                        dailyInterests: "Night strolls, leaf collecting",
                        likes: "Night",
                        dislikes: "Sunlight",
                        favoriteFood: "Mango smoothie, berries",
                        favoriteMusic: "Chill beats, ambient",
                        favoriteMovies: "Thrillers",
                        favoriteGames: "Puzzle adventures"
                    }
                },
                "Notia": {
                    en: {
                        age: 23,
                        birthday: "September 1",
                        zodiac: "Virgo",
                        personality: "Calm, graceful, and classical",
                        dailyInterests: "Tea ceremony, flower arranging",
                        likes: "Tea fragrance",
                        dislikes: "Coffee",
                        favoriteFood: "Japanese sweets, matcha ice cream",
                        favoriteMusic: "Folk music",
                        favoriteMovies: "Historical dramas",
                        favoriteGames: "Card strategy"
                    }
                },
                "QuQu": {
                    en: {
                        age: 22,
                        birthday: "April 20",
                        zodiac: "Taurus",
                        personality: "Bold, passionate, and straightforward",
                        dailyInterests: "Extreme sports",
                        likes: "Adventures",
                        dislikes: "Restrictions",
                        favoriteFood: "Grilled skewers, corn",
                        favoriteMusic: "Rock, metal",
                        favoriteMovies: "Action blockbusters",
                        favoriteGames: "Competitive multiplayer"
                    }
                },
                "Rainy": {
                    en: {
                        age: 21,
                        birthday: "November 5",
                        zodiac: "Scorpio",
                        personality: "Quiet, gentle, and introspective",
                        dailyInterests: "Walking in the rain",
                        likes: "Rain",
                        dislikes: "Hot days",
                        favoriteFood: "Ramen, hot chocolate",
                        favoriteMusic: "Slow jazz",
                        favoriteMovies: "Indie films",
                        favoriteGames: "Interactive fiction"
                    }
                },
                "Rindo": {
                    en: {
                        age: 25,
                        birthday: "February 1",
                        zodiac: "Aquarius",
                        personality: "Cool-headed, tough, and determined",
                        dailyInterests: "Kendo practice",
                        likes: "Cold",
                        dislikes: "Sweetness",
                        favoriteFood: "Grilled lamb skewers",
                        favoriteMusic: "Metal, electronic",
                        favoriteMovies: "Martial arts action films",
                        favoriteGames: "Hardcore action"
                    }
                },
                "Sikirei": {
                    en: {
                        age: 24,
                        birthday: "October 10",
                        zodiac: "Libra",
                        personality: "Alluring, mysterious, and refined",
                        dailyInterests: "Astrology research",
                        likes: "Stars and night sky",
                        dislikes: "Light pollution",
                        favoriteFood: "Blueberry pudding, herbal tea",
                        favoriteMusic: "Ambient soundscapes",
                        favoriteMovies: "Sci-fi mysteries",
                        favoriteGames: "The Sims"
                    }
                },
                "Vivi": {
                    en: {
                        age: 19,
                        birthday: "August 25",
                        zodiac: "Virgo",
                        personality: "Outgoing, cheerful, and sociable",
                        dailyInterests: "Live streaming, manga collecting",
                        likes: "Gatherings",
                        dislikes: "Shyness",
                        favoriteFood: "Pizza, snack platters",
                        favoriteMusic: "Pop, remixes",
                        favoriteMovies: "Comedies",
                        favoriteGames: "MMOs, casual"
                    }
                },
                "Wolf": {
                    en: {
                        age: 20,
                        birthday: "January 28",
                        zodiac: "Aquarius",
                        personality: "Wild, aloof, and instinct-driven",
                        dailyInterests: "Night exploration, survival",
                        likes: "Forests",
                        dislikes: "Noise",
                        favoriteFood: "Roasted venison",
                        favoriteMusic: "Folk, acoustic",
                        favoriteMovies: "Horror thrillers",
                        favoriteGames: "Survival crafting"
                    }
                },
                "Wolferia": {
                    en: {
                        age: 23,
                        birthday: "March 30",
                        zodiac: "Aries",
                        personality: "Free-spirited, adventurous",
                        dailyInterests: "Skiing, extreme sports",
                        likes: "Snow",
                        dislikes: "Heat",
                        favoriteFood: "Ice cream, cones",
                        favoriteMusic: "Trance",
                        favoriteMovies: "Adventure fantasies",
                        favoriteGames: "Winter sports"
                    }
                },
                "Yawl": {
                    en: {
                        age: 24,
                        birthday: "May 2",
                        zodiac: "Taurus",
                        personality: "Elegant, intellectual, aloof",
                        dailyInterests: "Literature appreciation",
                        likes: "Caf√©s",
                        dislikes: "Noise",
                        favoriteFood: "Pastries, black tea",
                        favoriteMusic: "Classical",
                        favoriteMovies: "Art-house dramas",
                        favoriteGames: "Puzzle mysteries"
                    }
                },
                "Yuuyii": {
                    en: {
                        age: 18,
                        birthday: "February 14",
                        zodiac: "Aquarius",
                        personality: "Sweet, kawaii-style, helpful",
                        dailyInterests: "Crafting hair accessories",
                        likes: "Pastels",
                        dislikes: "Stress",
                        favoriteFood: "Strawberry mousse, cotton candy",
                        favoriteMusic: "J-Pop, children‚Äôs songs",
                        favoriteMovies: "Anime films",
                        favoriteGames: "Life sims"
                    }
                },
                "Zwei": {
                    en: {
                        age: 25,
                        birthday: "December 5",
                        zodiac: "Sagittarius",
                        personality: "Steady, protective, loyal",
                        dailyInterests: "Martial arts training",
                        likes: "Night",
                        dislikes: "Harsh light",
                        favoriteFood: "Peking duck, steak",
                        favoriteMusic: "Percussion rhythms",
                        favoriteMovies: "War epics, epic fantasies",
                        favoriteGames: "Strategy sims"
                    }
                }
            };

            // Get profile for specified character and language
            const characterData = profilesData[name];

            // A) If English and has authoritative data from character.md, return first
            if (language === 'en' && englishProfiles) {
                const enByCanonical = englishProfiles[canonicalName(name)];
                if (enByCanonical) return enByCanonical;
            }

            // B) If data is grouped by language
            if (characterData && (characterData['zh'] || characterData['en'])) {
                const localized = characterData[language] || characterData['en'] || characterData['zh'];
                return maybeTranslateProfile(localized, language);
            }

            // C) Flat structure (mostly Chinese), do necessary conversion
            if (characterData && (typeof characterData.age !== 'undefined' || typeof characterData.birthday !== 'undefined')) {
                return maybeTranslateProfile(characterData, language);
            }

            // 3) Final fallback (guaranteed data)
            return language === 'zh' ? {
                age: 20,
                birthday: "4Êúà15Êó•",
                zodiac: "Áâ°ÁæäÂ∫ß",
                personality: "Ê∏©Êüî‰ΩìË¥¥ÁöÑAIÂ•≥ÂèãÔºåÊÄªyesoffÂøÉÁùÄ‰Ω†",
                dailyInterests: "ËÅäÂ§©„ÄÅÊ∏∏Êàè",
                likes: "Âíå‰Ω†at‰∏ÄËµ∑ÁöÑÊó∂ÂÖâ",
                dislikes: "Â≠§Âçï",
                favoriteFood: "ÁîúÁÇπ",
                favoriteMusic: "ËΩªÈü≥‰πê",
                favoriteMovies: "Êµ™Êº´Áâá",
                favoriteGames: "Casual Game"
            } : {
                age: 20,
                birthday: "April 15",
                zodiac: "Aries",
                personality: "Gentle and caring AI girlfriend who always cares about you",
                dailyInterests: "Chatting, gaming",
                likes: "Time spent with you",
                dislikes: "Loneliness",
                favoriteFood: "Desserts",
                favoriteMusic: "Light music",
                favoriteMovies: "Romance films",
                favoriteGames: "Casual games"
            };
        }

        // Try minimal necessary localization conversion for some fields (currently only zodiac signs)
        function maybeTranslateProfile(profile, language) {
            if (!profile) return profile;
            const result = { ...profile };
            if (language === 'en' && result.zodiac) {
                const zodiacMap = {
                    'ÁôΩÁæäÂ∫ß': 'Aries',
                    'Áâ°ÁæäÂ∫ß': 'Aries',
                    'ÈáëÁâõÂ∫ß': 'Taurus',
                    'ÂèåÂ≠êÂ∫ß': 'Gemini',
                    'Â∑®ËüπÂ∫ß': 'Cancer',
                    'ÁãÆÂ≠êÂ∫ß': 'Leo',
                    'Â§ÑÂ•≥Â∫ß': 'Virgo',
                    'Libra': 'Libra',
                    'Â§©Ë†çÂ∫ß': 'Scorpio',
                    'Â§©ËùéÂ∫ß': 'Scorpio',
                    'Â∞ÑÊâãÂ∫ß': 'Sagittarius',
                    'Êë©ÁæØÂ∫ß': 'Capricorn',
                    'Ê∞¥Áì∂Â∫ß': 'Aquarius',
                    'ÂèåÈ±ºÂ∫ß': 'Pisces'
                };
                result.zodiac = zodiacMap[result.zodiac] || result.zodiac;
            }
            return result;
        }

        function updateThumbnails() {
            // Simply regenerate the thumbnails without calling updateThumbnails again
            const containerLeft = document.getElementById('character-thumbnails');
            const containerRight = document.getElementById('character-thumbnails-right');
            containerLeft.innerHTML = '';
            containerRight.innerHTML = '';

            const currentIndex = currentCharacterIndex;
            const showCount = 4; // Show 4 characters on each side

            // Update selected character image
            const selectedAvatar = document.getElementById('selected-avatar-img');
            selectedAvatar.src = getProfilePicture(characters[currentIndex].name);

            // Update character profile information
            updateCharacterProfile(characters[currentIndex]);

            // Left characters (3 before current)
            for (let i = showCount; i > 0; i--) {
                const index = (currentIndex - i + characters.length) % characters.length;
                const character = characters[index];

                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);

                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;

                thumb.appendChild(content);
                containerLeft.appendChild(thumb);
            }

            // Right characters (3 after current)
            for (let i = 1; i <= showCount; i++) {
                const index = (currentIndex + i) % characters.length;
                const character = characters[index];

                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);

                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;

                thumb.appendChild(content);
                containerRight.appendChild(thumb);
            }
        }


        function selectCharacter(index) {
            if (index !== currentCharacterIndex && !isLoading) {
                loadCharacter(index);
            }
        }


        async function playVoiceSample(language) {
            // Stop currently playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            const character = characters[currentCharacterIndex];
            const sampleText = character.sampleLines?.[language];
            const voiceId = character.voiceId;

            if (!sampleText || !voiceId) {
                console.warn(`Missing sample text or voice ID for ${character.name} in ${language}`);
                return;
            }

            // Update button status
            updateLanguageButtons(language);
            currentLanguage = language;

            // Show play prompt
            console.log(`üéµ Playing ${character.name}'s ${language} sample: "${sampleText}"`);

            try {
                // Use ElevenLabs API to generate voice
                const audioUrl = await generateElevenLabsVoice(sampleText, voiceId);

                if (audioUrl) {
                    // Play generated audio
                    const audio = new Audio(audioUrl);
                    currentAudio = audio;

                    audio.onended = () => {
                        currentAudio = null;
                        // Clean temporary URL
                        URL.revokeObjectURL(audioUrl);
                    };

                    audio.onerror = () => {
                        console.error('Audio playback failed');
                        currentAudio = null;
                        URL.revokeObjectURL(audioUrl);
                    };

                    await audio.play();
                } else {
                    console.error('Voice generation failed');
                }
            } catch (error) {
                console.error('‚ùå ElevenLabs API request failed:', error);
                console.error('üö´ Voice playback failed. Check API key and network.');
            }
        }

        // Generate voice sample through backend API
        async function generateElevenLabsVoice(text, voiceId) {
            console.log(`üîÑ Generating voice sample...`);
            console.log(`üìù Text: "${text}"`);
            console.log(`üé§ Voice ID: ${voiceId}`);

            try {
                // Use dedicated voice demo interface
                const response = await fetch('/api/voice-sample', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        voiceId: voiceId
                    })
                });

                if (!response.ok) {
                    throw new Error(`Backend API error: ${response.status}`);
                }

                // Directly receive audio data
                const audioBlob = await response.blob();
                console.log('üéµ Audio received:', audioBlob.size, 'bytes');

                // Create audio URL
                const audioUrl = URL.createObjectURL(audioBlob);
                console.log('‚úÖ Voice sample generated');
                return audioUrl;

            } catch (error) {
                console.error('‚ùå Voice sample generation failed:', error);
                return null;
            }
        }

        function updateLanguageButtons(activeLanguage) {
            const buttons = document.querySelectorAll('.flag-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === activeLanguage) {
                    btn.classList.add('active');
                }
            });
        }

        function updateVoiceSelector() {
            // Ensure button state is correct, use default if currentLanguage not initialized
            const language = (typeof currentLanguage !== 'undefined') ? currentLanguage : 'jp';
            updateLanguageButtons(language);
        }

        function previousCharacter() {
            const newIndex = currentCharacterIndex > 0 ? currentCharacterIndex - 1 : characters.length - 1;
            selectCharacter(newIndex);
        }

        function nextCharacter() {
            const newIndex = currentCharacterIndex < characters.length - 1 ? currentCharacterIndex + 1 : 0;
            selectCharacter(newIndex);
        }


        // Loader control functions
        function showCharacterLoader() {
            const loader = document.getElementById('character-loader');
            loader.style.display = 'flex';
        }

        function hideCharacterLoader() {
            const loader = document.getElementById('character-loader');
            loader.style.display = 'none';
        }

        // globalfunction
        window.selectCharacter = selectCharacter;
        window.previousCharacter = previousCharacter;
        window.nextCharacter = nextCharacter;
        window.playVoiceSample = playVoiceSample;
        window.startChat = function () {
            console.log('üöÄ Start button clicked!');
            console.log('Current character index:', currentCharacterIndex);
            console.log('Characters length:', characters.length);

            // Check if character is selected
            if (currentCharacterIndex < 0 || !characters[currentCharacterIndex]) {
                console.log('‚ùå No character selected');
                alert('Please select a character first!');
                return;
            }

            console.log('‚úÖ All checks passed, proceeding to chat...');

            const selectedCharacter = characters[currentCharacterIndex];

            // Save character info
            const characterWithUser = {
                id: selectedCharacter.id,
                name: selectedCharacter.name,
                file: selectedCharacter.file,
                voiceId: selectedCharacter.voiceId,
                description: getCharacterDescription(selectedCharacter),
                connectedAt: Date.now()
            };

            // Save to localStorage
            localStorage.setItem('selectedCharacter', JSON.stringify(characterWithUser));
            localStorage.setItem('userId', 'guest-user');

            (window.AppConfig?.debug?.log || console.log)('Start chat with:', selectedCharacter.name);

            // Jump to chat interface
            window.location.href = 'chat.html';
        };

        // Mixamo to VRM bone mapping - copied from index.html
        const mixamoVRMRigMap = {
            mixamorigHips: 'hips',
            mixamorigSpine: 'spine',
            mixamorigSpine1: 'chest',
            mixamorigSpine2: 'upperChest',
            mixamorigNeck: 'neck',
            mixamorigHead: 'head',
            mixamorigLeftShoulder: 'leftShoulder',
            mixamorigLeftArm: 'leftUpperArm',
            mixamorigLeftForeArm: 'leftLowerArm',
            mixamorigLeftHand: 'leftHand',
            mixamorigLeftHandThumb1: 'leftThumbMetacarpal',
            mixamorigLeftHandThumb2: 'leftThumbProximal',
            mixamorigLeftHandThumb3: 'leftThumbDistal',
            mixamorigLeftHandIndex1: 'leftIndexProximal',
            mixamorigLeftHandIndex2: 'leftIndexIntermediate',
            mixamorigLeftHandIndex3: 'leftIndexDistal',
            mixamorigLeftHandMiddle1: 'leftMiddleProximal',
            mixamorigLeftHandMiddle2: 'leftMiddleIntermediate',
            mixamorigLeftHandMiddle3: 'leftMiddleDistal',
            mixamorigLeftHandRing1: 'leftRingProximal',
            mixamorigLeftHandRing2: 'leftRingIntermediate',
            mixamorigLeftHandRing3: 'leftRingDistal',
            mixamorigLeftHandPinky1: 'leftLittleProximal',
            mixamorigLeftHandPinky2: 'leftLittleIntermediate',
            mixamorigLeftHandPinky3: 'leftLittleDistal',
            mixamorigRightShoulder: 'rightShoulder',
            mixamorigRightArm: 'rightUpperArm',
            mixamorigRightForeArm: 'rightLowerArm',
            mixamorigRightHand: 'rightHand',
            mixamorigRightHandPinky1: 'rightLittleProximal',
            mixamorigRightHandPinky2: 'rightLittleIntermediate',
            mixamorigRightHandPinky3: 'rightLittleDistal',
            mixamorigRightHandRing1: 'rightRingProximal',
            mixamorigRightHandRing2: 'rightRingIntermediate',
            mixamorigRightHandRing3: 'rightRingDistal',
            mixamorigRightHandMiddle1: 'rightMiddleProximal',
            mixamorigRightHandMiddle2: 'rightMiddleIntermediate',
            mixamorigRightHandMiddle3: 'rightMiddleDistal',
            mixamorigRightHandIndex1: 'rightIndexProximal',
            mixamorigRightHandIndex2: 'rightIndexIntermediate',
            mixamorigRightHandIndex3: 'rightIndexDistal',
            mixamorigRightHandThumb1: 'rightThumbMetacarpal',
            mixamorigRightHandThumb2: 'rightThumbProximal',
            mixamorigRightHandThumb3: 'rightThumbDistal',
            mixamorigLeftUpLeg: 'leftUpperLeg',
            mixamorigLeftLeg: 'leftLowerLeg',
            mixamorigLeftFoot: 'leftFoot',
            mixamorigLeftToeBase: 'leftToes',
            mixamorigRightUpLeg: 'rightUpperLeg',
            mixamorigRightLeg: 'rightLowerLeg',
            mixamorigRightFoot: 'rightFoot',
            mixamorigRightToeBase: 'rightToes',
        };

        // Use same loadMixamoAnimation function as index.html
        function loadMixamoAnimation(url, vrm) {
            const loader = new FBXLoader();
            return loader.loadAsync(url).then((asset) => {
                const clip = THREE.AnimationClip.findByName(asset.animations, 'mixamo.com');

                if (!clip) {
                    throw new Error('Êâæ‰∏çto Mixamo Âä®Áîªdata');
                }

                const tracks = [];
                const restRotationInverse = new THREE.Quaternion();
                const parentRestWorldRotation = new THREE.Quaternion();
                const _quatA = new THREE.Quaternion();

                const motionHipsHeight = asset.getObjectByName('mixamorigHips').position.y;
                const vrmHipsHeight = vrm.humanoid.normalizedRestPose.hips.position[1];
                const hipsPositionScale = vrmHipsHeight / motionHipsHeight;

                clip.tracks.forEach((track) => {
                    const trackSplitted = track.name.split('.');
                    const mixamoRigName = trackSplitted[0];
                    const vrmBoneName = mixamoVRMRigMap[mixamoRigName];
                    const vrmNodeName = vrm.humanoid?.getNormalizedBoneNode(vrmBoneName)?.name;
                    const mixamoRigNode = asset.getObjectByName(mixamoRigName);

                    if (vrmNodeName != null) {
                        const propertyName = trackSplitted[1];

                        mixamoRigNode.getWorldQuaternion(restRotationInverse).invert();
                        mixamoRigNode.parent.getWorldQuaternion(parentRestWorldRotation);

                        if (track instanceof THREE.QuaternionKeyframeTrack) {
                            for (let i = 0; i < track.values.length; i += 4) {
                                const flatQuaternion = track.values.slice(i, i + 4);
                                _quatA.fromArray(flatQuaternion);

                                _quatA
                                    .premultiply(parentRestWorldRotation)
                                    .multiply(restRotationInverse);

                                _quatA.toArray(flatQuaternion);
                                flatQuaternion.forEach((v, index) => {
                                    track.values[index + i] = v;
                                });
                            }

                            tracks.push(
                                new THREE.QuaternionKeyframeTrack(
                                    `${vrmNodeName}.${propertyName}`,
                                    track.times,
                                    track.values.map((v, i) => (vrm.meta?.metaVersion === '0' && i % 2 === 0 ? -v : v)),
                                )
                            );

                        } else if (track instanceof THREE.VectorKeyframeTrack) {
                            const value = track.values.map((v, i) =>
                                (vrm.meta?.metaVersion === '0' && i % 3 !== 1 ? -v : v) * hipsPositionScale
                            );
                            tracks.push(new THREE.VectorKeyframeTrack(`${vrmNodeName}.${propertyName}`, track.times, value));
                        }
                    }
                });

                return new THREE.AnimationClip('vrmAnimation', clip.duration, tracks);
            });
        }

        // Load default animation
        async function loadDefaultAnimation() {
            if (!currentVRM || !mixer) return Promise.resolve();

            try {
                const clip = await loadMixamoAnimation(encodeURI('mixamo animation/Look Around.fbx'), currentVRM);

                if (animationAction) {
                    animationAction.stop();
                }

                animationAction = mixer.clipAction(clip);
                animationAction.reset().play();
                animationAction.timeScale = 0.7;

                (window.AppConfig?.debug?.log || console.log)('Bashful animation played');
                return Promise.resolve();
            } catch (error) {
                (window.AppConfig?.debug?.warn || console.warn)('Default animation failed:', error);
                return Promise.resolve(); // still resolve to show VRM
            }
        }

        // Debug helper
        window.debugScene = function () {
            (window.AppConfig?.debug?.log || console.log)('Scene children count:', scene?.children?.length ?? 0);
            (window.AppConfig?.debug?.log || console.log)('Current character index:', currentCharacterIndex);
        };

        // Language switch function - globally accessible
        window.switchLanguage = function (lang) {
            if (window.i18n) {
                window.i18n.switchLanguage(lang);
            }

            // Save language setting to localStorage
            localStorage.setItem('language', lang);

            // Update language button status
            const enBtn = document.getElementById('lang-en');
            const zhBtn = document.getElementById('lang-zh');
            if (enBtn && zhBtn) {
                enBtn.classList.toggle('active', lang === 'en');
                zhBtn.classList.toggle('active', lang === 'zh');
            }

            // Re-update current character profile panel
            if (typeof currentCharacterIndex !== 'undefined' && currentCharacterIndex >= 0 && characters[currentCharacterIndex]) {
                updateCharacterProfile(characters[currentCharacterIndex]);
            }
        };

        // Initialize language switcher
        function initLanguageToggle() {
            if (window.i18n) {
                const currentLang = window.i18n.getCurrentLanguage();
                const enBtn = document.getElementById('lang-en');
                const zhBtn = document.getElementById('lang-zh');

                if (enBtn && zhBtn) {
                    enBtn.classList.toggle('active', currentLang === 'en');
                    zhBtn.classList.toggle('active', currentLang === 'zh');
                }
            }
        }

        // Initialize language switcher and parse English profile after DOM loading complete
        document.addEventListener('DOMContentLoaded', () => {
            initLanguageToggle();
            loadEnglishProfiles();
        });

        // Listen to language switch events, update character info
        window.addEventListener('languageChanged', function (event) {
            // If currently has selected character, re-update its info
            if (typeof currentCharacterIndex !== 'undefined' && characters[currentCharacterIndex]) {
                updateCharacterProfile(characters[currentCharacterIndex]);
            }
        });
    </script>

    <!-- React Âíå Solana Web3 -->
    <script src="config.js"></script>
    <script src="i18n.characters.generated.js"></script>
    <script src="i18n.js"></script>
    <script src="simplified_characters.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- X Layer Wallet Connection Component -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Wallet component removed
        window.modernWalletUI = {};
        window.walletManager = { getWalletInfo: () => ({ isConnected: false, wallet: null }) };



    </script>

    const copyBtn = document.getElementById('copy-address-btn');
    if (copyBtn) {
    copyBtn.addEventListener('click', () => this.copyAddress());
    }

    // Disconnect
    const disconnectBtn = document.getElementById('disconnect-wallet-btn');
    if (disconnectBtn) {
    disconnectBtn.addEventListener('click', () => this.disconnect());
    }

    // clicked elsewhere to close dropdown
    document.addEventListener('click', () => {
    this.hideDropdown();
    });
    }

    showWalletModal() {
    const modal = document.getElementById('wallet-modal');
    if (modal) {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    }
    }

    hideWalletModal() {
    const modal = document.getElementById('wallet-modal');
    if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = '';
    }
    }

    async connectWallet(walletName) {
    try {
    (window.AppConfig?.debug?.log || console.log)(`Connect wallet: ${walletName}`);

    // Check if wallet is configured
    const walletConfig = this.wallets.find(w => w.name.toLowerCase() === walletName.toLowerCase());
    if (!walletConfig) {
    throw new Error(`wallet ${walletName} Êú™ÊâætoÊàñÊú™installed`);
    }

    const adapter = walletConfig.adapter();
    if (!adapter) {
    this.showToast(`${walletName} walletÊú™installed`, 'error');
    return;
    }

    // Update button status
    this.updateConnectButton(true);

    // Connect wallet
    let response;
    if (adapter.connect) {
    response = await adapter.connect();
    } else if (adapter.publicKey && adapter.isConnected) {
    response = { publicKey: adapter.publicKey };
    } else {
    throw new Error('walletadaptiveÂô®‰∏çsupportedconnected');
    }

    const address = response.publicKey.toString();

    // savedconnectedstatus
    this.selectedWallet = {
    name: walletName,
    adapter,
    address,
    config: walletConfig
    };
    this.isConnected = true;

    // Save to localStorage
    localStorage.setItem('wallet_address', address);
    localStorage.setItem('wallet_type', walletName.toLowerCase());

    (window.AppConfig?.debug?.log || console.log)(`Wallet connected: ${walletName}`, address);

    // Update UI
    this.updateUI();
    this.hideWalletModal();
    this.showToast(`${walletName} Connection successful!`, 'success');

    // Trigger global event
    window.dispatchEvent(new CustomEvent('walletConnected', {
    detail: { address, provider: walletName.toLowerCase() }
    }));

    } catch (error) {
    console.error('‚ùå Wallet connection failed:', error);
    this.updateConnectButton(false);
    this.showToast(`Connection failed: ${error.message}`, 'error');
    }
    }

    async disconnect() {
    try {
    (window.AppConfig?.debug?.log || console.log)('Disconnect wallet...');

    if (this.selectedWallet?.adapter?.disconnect) {
    await this.selectedWallet.adapter.disconnect();
    }

    // clean up status
    this.selectedWallet = null;
    this.isConnected = false;

    // Clear localStorage
    localStorage.removeItem('wallet_address');
    localStorage.removeItem('wallet_type');
    localStorage.removeItem('selectedCharacter');

    // Update UI
    this.updateUI();
    this.hideDropdown();
    this.showToast(i18n.t('wallet.disconnected'), 'success');

    // Trigger global event
    window.dispatchEvent(new CustomEvent('walletDisconnected'));

    } catch (error) {
    console.error('‚ùå Disconnect failed:', error);
    // Force clean up status
    this.selectedWallet = null;
    this.isConnected = false;
    localStorage.clear();
    this.updateUI();
    }
    }

    checkExistingConnection() {
    const savedAddress = localStorage.getItem('wallet_address');
    const savedType = localStorage.getItem('wallet_type');

    if (savedAddress && savedType) {
    (window.AppConfig?.debug?.log || console.log)('Check saved wallet connection...');

    const walletConfig = this.wallets.find(w => w.name.toLowerCase() === savedType.toLowerCase());
    if (walletConfig) {
    const adapter = walletConfig.adapter();
    if (adapter && adapter.isConnected && adapter.publicKey) {
    this.selectedWallet = {
    name: walletConfig.name,
    adapter,
    address: savedAddress,
    config: walletConfig
    };
    this.isConnected = true;
    this.updateUI();
    (window.AppConfig?.debug?.log || console.log)('Auto reconnected:', savedAddress);
    }
    }
    }
    }

    updateUI() {
    const connectButton = document.getElementById('wallet-connect-button');
    const walletInfo = document.getElementById('wallet-info');
    const walletAddress = document.getElementById('wallet-address');
    const walletAvatar = document.getElementById('wallet-avatar');

    if (this.isConnected && this.selectedWallet) {
    // Connected status
    if (connectButton) connectButton.style.display = 'none';
    if (walletInfo) walletInfo.style.display = 'flex';
    if (walletAddress) walletAddress.textContent = this.formatAddress(this.selectedWallet.address);
    if (walletAvatar) walletAvatar.textContent = this.selectedWallet.config.icon;
    } else {
    // display not connected status
    if (connectButton) connectButton.style.display = 'flex';
    if (walletInfo) walletInfo.style.display = 'none';
    }
    }

    updateConnectButton(loading) {
    const button = document.getElementById('wallet-connect-button');
    if (!button) return;

    const textSpan = button.querySelector('.wallet-text');
    if (loading) {
    button.disabled = true;
    if (textSpan) textSpan.textContent = 'Connecting...';
    } else {
    button.disabled = false;
    if (textSpan) textSpan.textContent = 'Connect';
    }
    }

    toggleDropdown() {
    const dropdown = document.getElementById('wallet-dropdown');
    if (dropdown) {
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
    }

    hideDropdown() {
    const dropdown = document.getElementById('wallet-dropdown');
    if (dropdown) {
    dropdown.style.display = 'none';
    }
    }

    copyAddress() {
    if (this.selectedWallet?.address) {
    navigator.clipboard.writeText(this.selectedWallet.address).then(() => {
    this.showToast('addressÂ∑≤copytoÂâ™Ë¥¥Êùø', 'success');
    }).catch(() => {
    this.showToast('copyfailed', 'error');
    });
    }
    this.hideDropdown();
    }

    formatAddress(address) {
    if (!address) return '';
    return `${address.slice(0, 6)}...${address.slice(-4)}`;
    }

    showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `wallet-toast wallet-toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
    toast.remove();
    }, 3000);
    }





    (window.AppConfig?.debug?.log || console.log)('ProfileManager initialized');

    // Initialize wallet manager
    let walletManager;
    document.addEventListener('DOMContentLoaded', () => {
    walletManager = new SolanaWalletManager();
    window.walletManager = walletManager; // Expose to global
    window.modernWalletUI = walletManager; // For backward compatibility
    });

    // compatible with old global function
    window.connectWallet = function() {
    if (walletManager) {
    walletManager.showWalletModal();
    }
    };

    window.disconnectWallet = function() {
    if (walletManager) {
    walletManager.disconnect();
    }
    };

    // user profile management system
    class UserProfileManager {
    constructor() {
    this.currentUserId = null;
    }

    // Check if user needs to fill profile - pure API driven, no localStorage
    async checkUserProfile(userId) {
    // Extract wallet address from userId
    const walletAddress = userId.replace('wallet_', '');



    // display profile registration panel
    showProfilePanel(userId = null, existingProfile = null) {
    const overlay = document.getElementById('user-profile-overlay');
    if (overlay) {
    // If in edit mode, fill existing data
    if (existingProfile) {
    this.fillFormWithProfile(existingProfile);
    // Change title to edit mode
    const title = overlay.querySelector('.profile-panel-title');
    if (title) title.textContent = i18n.t('registration.edit.title');
    } else {
    // Reset form
    this.resetForm();
    const title = overlay.querySelector('.profile-panel-title');
    if (title) title.textContent = i18n.t('registration.title');
    }

    // Initialize month and date selectors
    setTimeout(() => {
    this.initDateSelectors();
    }, 100);
    overlay.style.display = 'flex';
    (window.AppConfig?.debug?.log || console.log)('Show user registration panel');
    }
    }

    // hide profile registration panel
    hideProfilePanel() {
    const overlay = document.getElementById('user-profile-overlay');
    if (overlay) {
    overlay.style.display = 'none';
    }
    }

    // Initialize month and date selectors
    initDateSelectors() {
    const yearSelect = document.getElementById('birthYear');
    const monthSelect = document.getElementById('birthMonth');
    const daySelect = document.getElementById('birthDay');

    if (!yearSelect || !monthSelect || !daySelect) {
    console.error('Date selectors not found');
    return;
    }

    // Clear and fill years (1950-2010, suitable for adult users)
    yearSelect.innerHTML = '<option value="">Âπ¥</option>';
    const currentYear = new Date().getFullYear();
    for (let i = currentYear - 15; i >= 1950; i--) {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = i;
    yearSelect.appendChild(option);
    }

    // Clear and fill months
    monthSelect.innerHTML = '<option value="">Êúà</option>';
    for (let i = 1; i <= 12; i++) { const option=document.createElement('option'); option.value=i; option.textContent=i;
        monthSelect.appendChild(option); } // Clear and fill dates (default 31 days)
        daySelect.innerHTML='<option value="">Êó•</option>' ; for (let i=1; i <=31; i++) { const
        option=document.createElement('option'); option.value=i; option.textContent=i; daySelect.appendChild(option); }
        // Update dates when month changes monthSelect.addEventListener('change', ()=> {
        this.updateDayOptions(monthSelect.value);
        });
        }

        // Update date options based on month
        updateDayOptions(month) {
        const daySelect = document.getElementById('birthDay');
        const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        const maxDays = month ? daysInMonth[month - 1] : 31;

        daySelect.innerHTML = '<option value="">Êó•</option>';
        for (let i = 1; i <= maxDays; i++) { const option=document.createElement('option'); option.value=i; const
            walletAddress=localStorage.getItem('wallet_address'); if (walletAddress) { const
            userId=`wallet_${walletAddress}`; const profile=window.profileManager.getUserProfile(userId); if (profile) {
            window.profileManager.showProfilePanel(userId, profile); (window.AppConfig?.debug?.log ||
            console.log)('Editing user profile'); } else { (window.AppConfig?.debug?.log || console.log)('Profile not
            found; show registration'); window.profileManager.showProfilePanel(); } } else {
            (window.AppConfig?.debug?.warn || console.warn)('Wallet not connected'); } }; // getcurrentuserprofile
            window.getCurrentProfile=function() { const walletAddress=localStorage.getItem('wallet_address'); if
            (walletAddress) { const userId=`wallet_${walletAddress}`; const
            profile=window.profileManager.getUserProfile(userId); (window.AppConfig?.debug?.log || console.log)('Current
            user profile available'); return profile; } else { (window.AppConfig?.debug?.warn || console.warn)('Wallet
            not connected'); return null; } }; </script>


            <!-- The old handleProfileSubmit script block has been removed for redesign. -->

</body>

</html>